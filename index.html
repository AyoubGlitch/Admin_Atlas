<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المتجر - أطلس ليبيا للحاسبات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <style>
        /* جميع الأنماط السابقة كما هي */
:root {
    --primary-color: #0074D9;
    --secondary-color: #2C3E50;
    --accent-color: #FFDC00;
    --light-color: #f8f9fa;
    --dark-color: #343a40;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --info-color: #17a2b8;
    --border-radius: 12px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background-color: #f5f7fb;
    color: #333;
}

.container {
    max-width: 100%;
    padding: 0 15px;
    margin: 0 auto;
}

header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 15px 0;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
}

.logo-container {
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.store-name {
    font-size: 20px;
    font-weight: bold;
}

.admin-menu {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
}

@media (min-width: 768px) {
    .admin-menu {
        margin-top: 0;
        gap: 15px;
    }
}

.menu-item {
    padding: 8px 15px;
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: background-color 0.3s;
    position: relative;
}

.menu-item.active {
    background-color: rgba(255, 255, 255, 0.3);
    font-weight: 500;
}

.notification-badge {
    position: absolute;
    top: -5px;
    left: -5px;
    background-color: var(--accent-color);
    color: var(--dark-color);
    border-radius: 50%;
    padding: 3px 6px;
    font-size: 10px;
    font-weight: bold;
    display: none;
}

.main-content {
    padding: 20px 0;
}

.page {
    display: none;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
}

.page.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
}

.section-title {
    font-size: 22px;
    margin-bottom: 20px;
    color: var(--secondary-color);
    padding-bottom: 10px;
    border-bottom: 2px solid var(--primary-color);
}

.add-product-btn {
    background-color: var(--success-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    cursor: pointer;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: transform 0.2s;
}

.add-product-btn:active {
    transform: scale(0.98);
}

.products-grid {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
}

.product-card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    padding: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: transform 0.2s, box-shadow 0.2s;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.product-card.dragging {
    opacity: 0.5;
    transform: scale(1.02);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.product-details {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
}

.product-image-thumb {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    background-color: #f0f0f0;
    flex-shrink: 0;
}

.product-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.product-name {
    font-weight: bold;
    font-size: 16px;
    color: var(--secondary-color);
}

.product-meta {
    display: flex;
    gap: 15px;
    font-size: 13px;
    color: #555;
    flex-wrap: wrap;
}

.product-meta span {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.quantity-display {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: bold;
}

.quantity-low {
    background-color: var(--warning-color);
    color: var(--dark-color);
}

.quantity-out {
    background-color: var(--danger-color);
    color: white;
}

.quantity-ok {
    background-color: var(--success-color);
    color: white;
}

.product-specs {
    font-size: 12px;
    color: #777;
    margin-top: 2px;
}

.product-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-right: 10px;
}

.action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: transform 0.2s, background-color 0.2s;
}

.action-btn:active {
    transform: scale(0.95);
}

.edit-btn {
    background-color: var(--primary-color);
    color: white;
}

.delete-btn {
    background-color: var(--danger-color);
    color: white;
}

.form-container {
    background-color: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    margin-bottom: 30px;
    animation: fadeIn 0.5s ease-in-out;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 16px;
}

.form-group textarea {
    min-height: 100px;
    resize: vertical;
}

.form-row {
    display: flex;
    gap: 15px;
    flex-direction: column;
}

@media (min-width: 600px) {
    .form-row {
        flex-direction: row;
    }
}

.form-row .form-group {
    flex: 1;
}

.form-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.submit-btn {
    background-color: var(--success-color);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 500;
    transition: transform 0.2s;
    position: relative;
}

.submit-btn:active {
    transform: scale(0.98);
}

.submit-btn.loading {
    pointer-events: none;
    opacity: 0.7;
}

.submit-btn.loading::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    top: 50%;
    left: 50%;
    margin-left: -10px;
    margin-top: -10px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.cancel-btn {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: var(--border-radius);
    cursor: pointer;
}

.search-container {
    margin-bottom: 20px;
}

.search-container input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 16px;
}

.categories-list {
    list-style: none;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.category-item {
    background-color: white;
    padding: 15px;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
}

.category-item:active {
    transform: scale(0.99);
}

.category-item.dragging {
    opacity: 0.5;
    transform: scale(1.02);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.category-details {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-grow: 1;
}

.category-image-thumb {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    flex-shrink: 0;
    background-color: #f0f0f0;
}

.drag-handle {
    cursor: grab;
    padding: 5px;
    font-size: 20px;
    color: #999;
}

.category-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.coupon-card {
    background-color: white;
    padding: 15px;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    margin-bottom: 15px;
}

.coupon-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.coupon-code {
    font-weight: bold;
    color: var(--primary-color);
}

.coupon-value {
    font-weight: 500;
}

.coupon-details {
    color: #666;
    font-size: 14px;
    margin-bottom: 10px;
}

.orders-list {
    margin-top: 20px;
}

.order-card {
    background-color: white;
    border-radius: var(--border-radius);
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

.order-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
    flex-wrap: wrap;
}

.order-id {
    font-weight: bold;
    color: var(--primary-color);
}

.order-date {
    color: #666;
    font-size: 14px;
}

.order-customer {
    margin-bottom: 10px;
}

.order-details-box {
    background-color: #f9f9f9;
    border: 1px solid #eee;
    border-radius: var(--border-radius);
    padding: 15px;
    margin-bottom: 15px;
    line-height: 1.8;
}

.order-details-box .detail-label {
    font-weight: bold;
    color: var(--secondary-color);
}

.order-details-box pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    background-color: #f1f1f1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    margin-top: 5px;
}

.order-products {
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.product-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    background-color: #f9f9f9;
    padding: 8px;
    border-radius: 8px;
}

.product-item img {
    width: 50px;
    height: 50px;
    object-fit: contain;
    border-radius: 4px;
}

.product-details {
    flex-grow: 1;
}

.order-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 10px;
    border-top: 1px solid #eee;
    flex-wrap: wrap;
    gap: 10px;
}

.order-total {
    font-weight: bold;
}

.order-status {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.status-pending {
    background-color: var(--warning-color);
    color: var(--dark-color);
}

.status-approved {
    background-color: var(--success-color);
    color: white;
}

.status-rejected {
    background-color: var(--danger-color);
    color: white;
}

.status-action {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 5px 15px;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: transform 0.2s;
    margin-right: 5px;
}

.reject-action {
    background-color: var(--danger-color);
}

.status-action:active {
    transform: scale(0.95);
}

.development-message {
    text-align: center;
    padding: 40px 20px;
    color: #777;
}

.development-message i {
    font-size: 40px;
    margin-bottom: 15px;
    color: #ccc;
}

.images-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.slider-image-item {
    background-color: white;
    padding: 10px;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
}

@media (min-width: 768px) {
    .slider-image-item {
        flex-direction: row;
        align-items: center;
    }
}

.slider-image-preview {
    width: 100%;
    height: 150px;
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    border-radius: 4px;
    background-color: #f8f9fa;
}

@media (min-width: 768px) {
    .slider-image-preview {
        width: 150px;
        height: 100px;
        flex-shrink: 0;
    }
}

.slider-image-url {
    flex-grow: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    direction: ltr;
    text-align: left;
    font-size: 14px;
    padding: 5px;
    background-color: #f8f9fa;
    border-radius: 4px;
    max-width: 100%;
}

.slider-image-actions {
    display: flex;
    gap: 10px;
}

.toggle-visibility-btn {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--primary-color);
    transition: color 0.2s;
}

.toggle-visibility-btn:hover {
    color: var(--secondary-color);
}

.toggle-visibility-btn.hidden {
    color: #ccc;
}

.timer-discount-section {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
}

.timer-discount-section h4 {
    margin-bottom: 15px;
    color: var(--secondary-color);
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 8px;
}

.timer-option {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.timer-inputs {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.timer-input-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.timer-input-group label {
    font-size: 14px;
    font-weight: 500;
}

.discount-option {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 15px;
}

.discount-input-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex: 1;
}

.discount-input-group label {
    font-size: 14px;
    font-weight: 500;
}

.specs-container {
    border: 1px solid #e0e0e0;
    border-radius: var(--border-radius);
    overflow: hidden;
    margin-bottom: 20px;
}

.specs-section {
    margin-bottom: 15px;
}

.specs-section-title {
    background-color: #f5f5f5;
    padding: 10px 15px;
    font-weight: bold;
    border-bottom: 1px solid #e0e0e0;
    margin-bottom: 10px;
}

.specs-item {
    display: flex;
    padding: 8px 15px;
    border-bottom: 1px solid #f0f0f0;
}

.specs-item:last-child {
    border-bottom: none;
}

.specs-label {
    font-weight: bold;
    width: 40%;
    padding-left: 10px;
}

.specs-value {
    width: 60%;
    color: #555;
}

.specs-input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.specs-input-group input {
    flex: 1;
}

.add-spec-btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: var(--border-radius);
    cursor: pointer;
    margin-bottom: 15px;
}

.specs-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: var(--border-radius);
    padding: 10px;
}

.spec-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid #f0f0f0;
}

.spec-item:last-child {
    border-bottom: none;
}

.remove-spec {
    color: var(--danger-color);
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
}

.order-coupon-info {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    margin: 10px 0;
    border-right: 4px solid var(--success-color);
}

.order-coupon-info strong {
    color: var(--success-color);
}

.delete-order-btn {
    background-color: var(--danger-color);
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
}

.search-orders-container {
    margin-bottom: 20px;
}

.search-orders-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 16px;
}

.view-products-btn {
    background-color: var(--info-color);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: transform 0.2s;
}

.view-products-btn:active {
    transform: scale(0.98);
}

.category-products-page {
    display: none;
}

.category-products-page.active {
    display: block;
}

.back-to-categories-btn {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: var(--border-radius);
    cursor: pointer;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.current-category-title {
    color: var(--primary-color);
    margin-bottom: 15px;
    font-size: 20px;
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease-in-out;
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background-color: white;
    border-radius: var(--border-radius);
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease-in-out;
    position: relative;
}

.modal-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 15px 20px;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 20px;
}

.close-modal {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}

.close-modal:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.modal-body {
    padding: 20px;
    overflow-y: auto;
    max-height: calc(90vh - 150px);
}

.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        opacity: 0;
        transform: translateY(-30px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

.modal .form-container {
    box-shadow: none;
    margin-bottom: 0;
    padding: 0;
}

.quantity-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 14px;
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.quantity-warning i {
    color: #f39c12;
}

#productFormContainer {
    display: none !important;
}

/* أنماط الحسابات */
.accounts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    width: 100%;
}

.account-card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    display: flex;
    flex-direction: column;
}

.account-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}

.account-card-header {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.account-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    font-weight: bold;
}

.account-info-summary {
    flex-grow: 1;
}

.account-name {
    font-size: 18px;
    font-weight: bold;
    color: var(--secondary-color);
    margin-bottom: 5px;
}

.account-phone {
    font-size: 14px;
    color: #666;
    direction: ltr;
    text-align: left;
}

.account-card-body {
    padding: 15px;
    flex-grow: 1;
}

.account-details {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}

.account-detail-item {
    display: flex;
    justify-content: space-between;
    padding-bottom: 8px;
    border-bottom: 1px dashed #eee;
}

.account-detail-label {
    font-weight: bold;
    color: var(--secondary-color);
}

.account-detail-value {
    color: #555;
}

.account-addresses {
    margin-top: 15px;
}

.address-item-small {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 5px;
    font-size: 13px;
}

.account-card-footer {
    padding: 15px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.user-orders-btn {
    background-color: var(--info-color);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.user-orders-page {
    display: none;
}

.user-orders-page.active {
    display: block;
}

.back-to-accounts-btn {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: var(--border-radius);
    cursor: pointer;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.user-info-header {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 20px;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.user-avatar-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 32px;
    font-weight: bold;
}

.user-details-large {
    flex-grow: 1;
}

.user-name-large {
    font-size: 24px;
    font-weight: bold;
    color: var(--secondary-color);
    margin-bottom: 5px;
}

.user-phone-large {
    font-size: 16px;
    color: #666;
    margin-top: 5px;
}

/* أنماط ترقيم الصفحات */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 30px 0;
    gap: 10px;
    flex-wrap: wrap;
}

.pagination button {
    background-color: white;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    padding: 8px 15px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
}

.pagination button:hover:not(:disabled) {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.pagination button:disabled {
    background-color: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
}

.pagination button.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.pagination-numbers {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    justify-content: center;
}

.pagination-number {
    min-width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.3s;
}

.pagination-number.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.pagination-number:hover:not(.active) {
    background-color: #f8f9fa;
}

/* نوافذ منبثقة إضافية */
#editAccountModal .form-group input[readonly] {
    background-color: #f8f9fa;
    cursor: not-allowed;
}

.address-item-full {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #e9ecef;
}

.address-item-full strong {
    color: var(--primary-color);
    display: block;
    margin-bottom: 5px;
}

.address-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.no-data-message {
    text-align: center;
    padding: 40px 20px;
    color: #777;
}

.no-data-message i {
    font-size: 40px;
    margin-bottom: 15px;
    color: #ccc;
}

.order-status-select-container {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.order-status-select {
    padding: 6px 12px;
    border-radius: var(--border-radius);
    border: 1px solid #ddd;
    background-color: white;
    font-size: 14px;
    cursor: pointer;
    min-width: 150px;
}

.order-status-select.pending {
    background-color: var(--warning-color);
    color: var(--dark-color);
    border-color: var(--warning-color);
}

.order-status-select.approved {
    background-color: var(--success-color);
    color: white;
    border-color: var(--success-color);
}

.order-status-select.rejected {
    background-color: var(--danger-color);
    color: white;
    border-color: var(--danger-color);
}

.update-status-btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 14px;
    transition: transform 0.2s;
    position: relative;
}

.update-status-btn:active {
    transform: scale(0.95);
}

.update-status-btn.loading {
    pointer-events: none;
    opacity: 0.7;
}

.update-status-btn.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 0.6s linear infinite;
}

.image-preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.image-preview {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #ddd;
}

.file-input-group {
    margin-bottom: 15px;
}

.file-input-label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.file-input-info {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.custom-file-upload {
    border: 2px dashed #0074D9;
    border-radius: var(--border-radius);
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 20px;
}

.custom-file-upload:hover {
    background-color: rgba(0, 116, 217, 0.05);
    border-color: #0056a6;
}

.custom-file-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
}

.custom-file-label i {
    font-size: 40px;
    color: #0074D9;
    margin-bottom: 10px;
}

.custom-file-label span {
    font-size: 18px;
    font-weight: 500;
    color: #333;
    margin-bottom: 10px;
}

.custom-file-info {
    font-size: 14px;
    color: #666;
    margin: 0;
}

.image-preview-item {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #ddd;
    transition: transform 0.2s;
}

.image-preview-item:hover {
    transform: scale(1.05);
    border-color: var(--primary-color);
}

.image-preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.remove-image-btn {
    position: absolute;
    top: 5px;
    left: 5px;
    background-color: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.3s;
}

.remove-image-btn:hover {
    background-color: #dc3545;
    transform: scale(1.1);
}

.add-more-images-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
}

.add-more-images-btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
    width: 100%;
    justify-content: center;
}

.add-more-images-btn:hover {
    background-color: #0056a6;
    transform: translateY(-2px);
}

.images-counter {
    font-size: 14px;
    color: #666;
    text-align: center;
}

.images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 15px;
    margin-top: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: var(--border-radius);
    max-height: 300px;
    overflow-y: auto;
}

.image-item {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.image-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-item-remove {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.no-images-message {
    text-align: center;
    padding: 20px;
    color: #777;
    grid-column: 1 / -1;
}

.custom-file-upload.highlight {
    background-color: rgba(0, 116, 217, 0.1);
    border-color: #0056a6;
    transform: scale(1.01);
}

/* أنماط تسجيل الدخول */
.login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    transition: opacity 0.5s ease-in-out;
}

.login-container {
    background-color: white;
    border-radius: var(--border-radius);
    padding: 40px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    animation: slideInUp 0.5s ease-in-out;
}

@keyframes slideInUp {
    from { 
        opacity: 0;
        transform: translateY(50px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

.login-logo {
    text-align: center;
    margin-bottom: 30px;
}

.login-logo img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin-bottom: 15px;
}

.login-logo h2 {
    color: var(--secondary-color);
    margin-bottom: 5px;
}

.login-logo p {
    color: #666;
    font-size: 14px;
}

.login-form .form-group {
    margin-bottom: 20px;
}

.login-form label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--secondary-color);
}

.login-form select, .login-form input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 16px;
    transition: border-color 0.3s;
}

.login-form select:focus, .login-form input:focus {
    border-color: var(--primary-color);
    outline: none;
}

.login-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s;
    margin-top: 10px;
}

.login-btn:active {
    transform: scale(0.98);
}

.login-error {
    background-color: rgba(220, 53, 69, 0.1);
    border: 1px solid var(--danger-color);
    color: var(--danger-color);
    padding: 10px;
    border-radius: var(--border-radius);
    margin-top: 15px;
    text-align: center;
    display: none;
}

/* أنماط حسابات المنظومة */
.system-account-card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    display: flex;
    flex-direction: column;
}

.system-account-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
}

.system-account-card-header {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.system-account-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    font-weight: bold;
}

.system-account-info-summary {
    flex-grow: 1;
}

.system-account-name {
    font-size: 18px;
    font-weight: bold;
    color: var(--secondary-color);
    margin-bottom: 5px;
}

.system-account-email {
    font-size: 14px;
    color: #666;
    direction: ltr;
    text-align: left;
    overflow: hidden;
    text-overflow: ellipsis;
}

.system-account-card-body {
    padding: 15px;
    flex-grow: 1;
}

.system-account-details {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}

.system-account-detail-item {
    display: flex;
    justify-content: space-between;
    padding-bottom: 8px;
    border-bottom: 1px dashed #eee;
}

.system-account-detail-label {
    font-weight: bold;
    color: var(--secondary-color);
}

.system-account-detail-value {
    color: #555;
}

.permissions-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.permission-tag {
    background-color: #e9ecef;
    color: #495057;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.permission-tag.view {
    background-color: #d1ecf1;
    color: #0c5460;
}

.permission-tag.edit {
    background-color: #d4edda;
    color: #155724;
}

.permission-tag.delete {
    background-color: #f8d7da;
    color: #721c24;
}

.permission-tag.none {
    background-color: #f8f9fa;
    color: #6c757d;
}

.system-account-card-footer {
    padding: 15px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.logout-btn {
    background-color: var(--warning-color);
    color: var(--dark-color);
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-left: auto;
}

.permissions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.permission-section {
    background-color: #f8f9fa;
    border-radius: var(--border-radius);
    padding: 15px;
    border: 1px solid #e9ecef;
}

.permission-section h5 {
    margin-bottom: 10px;
    color: var(--secondary-color);
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 5px;
}

.permission-options {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.permission-option {
    display: flex;
    align-items: center;
    gap: 8px;
}

.permission-option input[type="checkbox"] {
    width: 18px;
    height: 18px;
}

.permission-option label {
    font-size: 14px;
    color: #495057;
    cursor: pointer;
}

.no-permission-message {
    text-align: center;
    padding: 50px 20px;
    color: #666;
}

.no-permission-message i {
    font-size: 60px;
    margin-bottom: 20px;
    color: #ccc;
}

.no-permission-message h3 {
    color: var(--secondary-color);
    margin-bottom: 10px;
}

.hidden-by-permission {
    display: none !important;
}

.permission-summary {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
    line-height: 1.4;
}

.login-form select option {
    padding: 10px;
    direction: ltr;
    text-align: left;
}
    </style>
</head>
<body>
    <!-- واجهة تسجيل الدخول -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <div class="login-logo">
                <div class="logo">
                    <img src="https://g.top4top.io/p_3538g44fy0.jpg" alt="شعار أطلس">
                </div>
                <h2>نظام إدارة المتجر</h2>
                <p>أطلس ليبيا للحاسبات</p>
            </div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">اختر الحساب</label>
                    <select id="loginEmail" required>
                        <option value="">اختر الحساب من القائمة</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">كلمة المرور</label>
                    <input type="password" id="loginPassword" required placeholder="أدخل كلمة المرور">
                </div>
                
                <div class="login-error" id="loginError">
                    <i class="fas fa-exclamation-circle"></i> البريد الإلكتروني أو كلمة المرور غير صحيحة
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> دخول إلى النظام
                </button>
            </form>
        </div>
    </div>

    <!-- نظام الإدارة (يظهر بعد تسجيل الدخول) -->
    <div id="adminSystem" style="display: none;">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo-container">
                        <div class="logo">
                            <img src="https://g.top4top.io/p_3538g44fy0.jpg" alt="شعار أطلس">
                        </div>
                        <div class="store-name">نظام إدارة المتجر</div>
                    </div>
                    <div class="admin-menu">
                        <div class="menu-item active" data-page="productsPage">المنتجات</div>
                        <div class="menu-item" data-page="categoriesPage">الفئات</div>
                        <div class="menu-item" data-page="couponsPage">الكوبونات</div>
                        <div class="menu-item" data-page="ordersPage">
                            الطلبات
                            <span id="orders-badge" class="notification-badge">0</span>
                        </div>
                        <div class="menu-item" data-page="sliderPage">السلايدر</div>
                        <div class="menu-item" data-page="accountsPage">
                            حسابات العملاء
                        </div>
                        <div class="menu-item" data-page="systemAccountsPage">
                            حسابات المنظومة
                        </div>
                        <button class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> خروج
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="main-content">
                <!-- صفحة المنتجات -->
                <div class="page active" id="productsPage">
                    <h2 class="section-title">إدارة المنتجات</h2>
                    <button class="add-product-btn hidden-by-permission" id="addProductBtn" data-permission="products.edit">
                        <i class="fas fa-plus"></i> إضافة منتج جديد
                    </button>
                    <div class="search-container">
                        <input type="text" id="productSearch" placeholder="ابحث عن منتج بالاسم...">
                    </div>

                    <div class="products-grid" id="productsGrid">
                    </div>
                    
                    <!-- ترقيم الصفحات للمنتجات -->
                    <div class="pagination" id="productsPagination" style="display: none;">
                        <button id="prevProductsPage" disabled>السابق</button>
                        <div class="pagination-numbers" id="productsPaginationNumbers"></div>
                        <button id="nextProductsPage">التالي</button>
                    </div>
                    
                    <p id="noProductsMessage" style="text-align: center; padding: 20px; display: none;">
                        <i class="fas fa-box-open" style="font-size: 24px; color: #ccc;"></i><br>
                        لا توجد منتجات حالياً. أضف منتجك الأول.
                    </p>
                </div>

                <!-- صفحة الفئات -->
                <div class="page" id="categoriesPage">
                    <h2 class="section-title">إدارة الفئات</h2>
                    
                    <!-- زر حفظ ترتيب الفئات -->
                    <button class="add-product-btn" id="saveCategoriesOrderBtn" style="background-color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-save"></i> حفظ ترتيب الفئات
                    </button>
                    
                    <div class="form-container hidden-by-permission" id="categoryFormContainer" data-permission="categories.edit">
                        <h3 id="categoryFormTitle">إضافة فئة جديدة</h3>
                        <form id="categoryForm">
                            <input type="hidden" id="categoryId">
                            <div class="form-group">
                                <label for="categoryName">اسم الفئة</label>
                                <input type="text" id="categoryName" required>
                            </div>
                            <div class="file-input-group">
                                <label class="file-input-label">صورة الفئة</label>
                                <div class="custom-file-upload">
                                    <input type="file" id="categoryImageFile" accept="image/*" style="display: none;">
                                    <label for="categoryImageFile" class="custom-file-label">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <span>انقر لاختيار صورة الفئة أو اسحبها هنا</span>
                                        <p class="custom-file-info">الحد الأقصى لحجم الصورة: 5MB. الأنواع المسموحة: JPG, PNG, GIF</p>
                                    </label>
                                </div>
                            </div>
                            <div class="image-preview-container" id="categoryImagePreview"></div>
                            <div class="form-buttons">
                                <button type="submit" class="submit-btn" id="saveCategoryBtn">حفظ الفئة</button>
                                <button type="button" class="cancel-btn" id="cancelCategoryBtn" style="display: none;">إلغاء</button>
                            </div>
                        </form>
                    </div>
                    <h3 style="margin: 20px 0 10px;">الفئات الحالية</h3>
                    <ul class="categories-list" id="categoriesList">
                    </ul>
                </div>

                <!-- صفحة عرض منتجات الفئة -->
                <div class="page category-products-page" id="categoryProductsPage">
                    <button class="back-to-categories-btn" id="backToCategoriesBtn">
                        <i class="fas fa-arrow-right"></i> العودة إلى الفئات
                    </button>
                    <h2 class="section-title">منتجات الفئة: <span id="currentCategoryTitle"></span></h2>
                    <div class="search-container">
                        <input type="text" id="categoryProductSearch" placeholder="ابحث عن منتج...">
                    </div>
                    <div class="products-grid" id="categoryProductsGrid">
                    </div>
                    
                    <!-- ترقيم الصفحات لمنتجات الفئة -->
                    <div class="pagination" id="categoryProductsPagination" style="display: none;">
                        <button id="prevCategoryProductsPage" disabled>السابق</button>
                        <div class="pagination-numbers" id="categoryProductsPaginationNumbers"></div>
                        <button id="nextCategoryProductsPage">التالي</button>
                    </div>
                    
                    <p id="noCategoryProductsMessage" style="text-align: center; padding: 20px; display: none;">
                        <i class="fas fa-box-open" style="font-size: 24px; color: #ccc;"></i><br>
                        لا توجد منتجات في هذه الفئة حالياً.
                    </p>
                </div>

                <!-- صفحة الكوبونات -->
                <div class="page" id="couponsPage">
                    <h2 class="section-title">إدارة الكوبونات</h2>
                    <div class="form-container hidden-by-permission" data-permission="coupons.edit">
                        <h3>إضافة كوبون جديد</h3>
                        <form id="couponForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="couponCode">كود الكوبون</label>
                                    <input type="text" id="couponCode" required>
                                </div>
                                <div class="form-group">
                                    <label for="couponValue">قيمة الخصم (د.ل)</label>
                                    <input type="number" id="couponValue" step="0.1" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="couponUsage">عدد مرات الاستخدام المسموحة</label>
                                    <input type="number" id="couponUsage" min="1" required>
                            </div>
                            <div class="form-buttons">
                                <button type="submit" class="submit-btn" id="saveCouponBtn">إضافة الكوبون</button>
                            </div>
                        </form>
                    </div>
                    <h3 style="margin: 20px 0 10px;">الكوبونات الحالية</h3>
                    <div id="couponsList">
                    </div>
                </div>

                <!-- صفحة الطلبات -->
                <div class="page" id="ordersPage">
                    <h2 class="section-title">إدارة الطلبات</h2>
                    <div class="search-orders-container">
                        <input type="text" id="orderSearch" class="search-orders-input" placeholder="ابحث عن طلب برقم الطلب، الاسم، الهاتف...">
                    </div>
                    <div class="orders-list" id="ordersList">
                        <p style="text-align: center; padding: 20px;">
                            <i class="fas fa-box-open" style="font-size: 24px; color: #ccc;"></i><br>
                            لا توجد طلبات جديدة حالياً.
                        </p>
                    </div>
                    
                    <!-- ترقيم الصفحات للطلبات -->
                    <div class="pagination" id="ordersPagination" style="display: none;">
                        <button id="prevOrdersPage" disabled>السابق</button>
                        <div class="pagination-numbers" id="ordersPaginationNumbers"></div>
                        <button id="nextOrdersPage">التالي</button>
                    </div>
                </div>

                <!-- صفحة طلبات مستخدم معين -->
                <div class="page user-orders-page" id="userOrdersPage">
                    <button class="back-to-accounts-btn" id="backToAccountsBtn">
                        <i class="fas fa-arrow-right"></i> العودة إلى الحسابات
                    </button>
                    <div class="user-info-header" id="userInfoHeader">
                        <!-- سيتم تعبئته بالجافاسكريبت -->
                    </div>
                    <h2 class="section-title">طلبات المستخدم</h2>
                    <div class="orders-list" id="userOrdersList">
                        <p style="text-align: center; padding: 20px;">
                            <i class="fas fa-box-open" style="font-size: 24px; color: #ccc;"></i><br>
                            لا توجد طلبات لهذا المستخدم.
                        </p>
                    </div>
                    
                    <!-- ترقيم الصفحات لطلبات المستخدم -->
                    <div class="pagination" id="userOrdersPagination" style="display: none;">
                        <button id="prevUserOrdersPage" disabled>السابق</button>
                        <div class="pagination-numbers" id="userOrdersPaginationNumbers"></div>
                        <button id="nextUserOrdersPage">التالي</button>
                    </div>
                </div>

                <!-- صفحة السلايدر -->
                <div class="page" id="sliderPage">
                    <h2 class="section-title">إدارة السلايدر</h2>
                    <div class="form-container hidden-by-permission" data-permission="slider.edit">
                        <h3>إضافة صورة جديدة للسلايدر</h3>
                        <form id="sliderForm">
                            <div class="file-input-group">
                                <label class="file-input-label">صورة السلايدر</label>
                                <div class="custom-file-upload">
                                    <input type="file" id="slideImageFile" accept="image/*" style="display: none;">
                                    <label for="slideImageFile" class="custom-file-label">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <span>انقر لاختيار صورة السلايدر أو اسحبها هنا</span>
                                        <p class="custom-file-info">الحد الأقصى لحجم الصورة: 5MB. الأنواع المسموحة: JPG, PNG, GIF</p>
                                    </label>
                                </div>
                            </div>
                            <div class="image-preview-container" id="slideImagePreview"></div>
                            <div class="form-buttons">
                                <button type="submit" class="submit-btn" id="addSliderImageBtn">إضافة الصورة</button>
                            </div>
                        </form>
                    </div>
                    <h3 style="margin: 20px 0 10px;">الصور الحالية</h3>
                    <div id="sliderImagesList" class="images-list">
                    </div>
                </div>

                <!-- صفحة حسابات العملاء -->
                <div class="page" id="accountsPage">
                    <h2 class="section-title">إدارة حسابات العملاء</h2>
                    
                    <div class="search-container">
                        <input type="text" id="accountSearch" placeholder="ابحث عن حساب بالاسم أو رقم الهاتف...">
                    </div>
                    
                    <div class="accounts-grid" id="accountsGrid">
                        <!-- سيتم تعبئته بالجافاسكريبت -->
                    </div>
                    
                    <!-- ترقيم الصفحات للحسابات -->
                    <div class="pagination" id="accountsPagination" style="display: none;">
                        <button id="prevAccountsPage" disabled>السابق</button>
                        <div class="pagination-numbers" id="accountsPaginationNumbers"></div>
                        <button id="nextAccountsPage">التالي</button>
                    </div>
                    
                    <div id="noAccountsMessage" class="no-data-message" style="display: none;">
                        <i class="fas fa-users-slash"></i>
                        <h3>لا توجد حسابات حالياً</h3>
                        <p>لم يتم إنشاء أي حسابات بعد.</p>
                    </div>
                </div>

                <!-- صفحة حسابات المنظومة -->
                <div class="page" id="systemAccountsPage">
                    <h2 class="section-title">إدارة حسابات المنظومة</h2>
                    
                    <button class="add-product-btn hidden-by-permission" id="addSystemAccountBtn" data-permission="systemAccounts.edit">
                        <i class="fas fa-plus"></i> إضافة حساب جديد
                    </button>
                    
                    <div class="search-container">
                        <input type="text" id="systemAccountSearch" placeholder="ابحث عن حساب بالبريد الإلكتروني...">
                    </div>
                    
                    <div class="accounts-grid" id="systemAccountsGrid">
                        <!-- سيتم تعبئته بالجافاسكريبت -->
                    </div>
                    
                    <!-- ترقيم الصفحات لحسابات المنظومة -->
                    <div class="pagination" id="systemAccountsPagination" style="display: none;">
                        <button id="prevSystemAccountsPage" disabled>السابق</button>
                        <div class="pagination-numbers" id="systemAccountsPaginationNumbers"></div>
                        <button id="nextSystemAccountsPage">التالي</button>
                    </div>
                    
                    <div id="noSystemAccountsMessage" class="no-data-message" style="display: none;">
                        <i class="fas fa-users-slash"></i>
                        <h3>لا توجد حسابات منظومة حالياً</h3>
                        <p>لم يتم إنشاء أي حسابات بعد.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================ النافذة المنبثقة لتعديل المنتج ================ -->
        <div class="modal-overlay" id="productModalOverlay">
            <div class="modal" id="productModal">
                <div class="modal-header">
                    <h3 id="productModalTitle">تعديل المنتج</h3>
                    <button class="close-modal" id="closeProductModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-container" id="productFormContainerModal">
                        <form id="productFormModal">
                            <input type="hidden" id="productIdModal">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productNameModal">اسم المنتج</label>
                                    <input type="text" id="productNameModal" required>
                                </div>
                                <div class="form-group">
                                    <label for="productCategoryModal">الفئة</label>
                                    <select id="productCategoryModal" required>
                                        <option value="">اختر الفئة</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productCostPriceModal">سعر التكلفة (د.ل)</label>
                                    <input type="number" id="productCostPriceModal" step="0.1" required>
                                </div>
                                <div class="form-group">
                                    <label for="productSellPriceModal">سعر البيع (د.ل)</label>
                                    <input type="number" id="productSellPriceModal" step="0.1" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productQuantityModal">الكمية المتوفرة</label>
                                    <input type="number" id="productQuantityModal" min="0" step="1" value="10" required>
                                    <div class="quantity-warning" id="quantityWarning" style="display: none;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span>عند حفظ الكمية كـ 0، سيظهر المنتج في المتجر مع وضع "نفذت الكمية"</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="productImagesInputModal">صور المنتج</label>
                                    <div class="custom-file-upload" id="productImagesUploadArea">
                                        <input type="file" id="productImagesInputModal" multiple accept="image/*" style="display: none;">
                                        <label for="productImagesInputModal" class="custom-file-label">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <span>انقر لاختيار صور المنتج أو اسحبها هنا</span>
                                            <p class="custom-file-info">يمكن رفع عدة صور معاً. الحد الأقصى للحجم 5MB لكل صورة</p>
                                        </label>
                                    </div>
                                    <div class="images-counter" id="imagesCounter">0 صور مرفوعة</div>
                                    <div class="images-grid" id="productImagesGrid">
                                        <!-- ستظهر الصور المختارة هنا -->
                                    </div>
                                    <div class="add-more-images-container">
                                        <button type="button" class="add-more-images-btn" id="addMoreImagesBtn">
                                            <i class="fas fa-plus-circle"></i>
                                            إضافة المزيد من الصور
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="generalDescriptionModal">كلام العام</label>
                                <textarea id="generalDescriptionModal" placeholder="وصف عام للمنتج"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>المواصفات</label>
                                <div class="specs-input-group">
                                    <input type="text" id="specLabelModal" placeholder="اسم المواصفة (مثل: حجم الشاشة)">
                                    <input type="text" id="specValueModal" placeholder="قيمة المواصفة (مثل: 14.6 بوصة)">
                                    <button type="button" class="add-spec-btn" id="addSpecBtnModal">إضافة</button>
                                </div>
                                <div class="specs-list" id="specsListModal">
                                    <!-- المواصفات المضافة ستظهر هنا -->
                                </div>
                            </div>
                            
                            <div class="timer-discount-section">
                                <h4>إعدادات الوقت والتخفيض</h4>
                                
                                <div class="timer-option">
                                    <input type="checkbox" id="enableTimerModal">
                                    <label for="enableTimerModal">تفعيل وقت ظهور المنتج</label>
                                </div>
                                
                                <div class="timer-inputs" id="timerInputsModal" style="display: none;">
                                    <div class="timer-input-group">
                                        <label for="timerHoursModal">الساعات</label>
                                        <input type="number" id="timerHoursModal" min="0" max="24" value="0">
                                    </div>
                                    <div class="timer-input-group">
                                        <label for="timerMinutesModal">الدقائق</label>
                                        <input type="number" id="timerMinutesModal" min="0" max="59" value="0">
                                    </div>
                                </div>
                                
                                <div class="discount-option">
                                    <input type="checkbox" id="enableDiscountModal">
                                    <label for="enableDiscountModal">تفعيل نسبة التخفيض</label>
                                </div>
                                
                                <div class="discount-input-group" id="discountInputModal" style="display: none;">
                                    <label for="discountPercentageModal">نسبة التخفيض (%)</label>
                                        <input type="number" id="discountPercentageModal" min="1" max="100" value="10">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="submit-btn" id="saveProductModal">حفظ المنتج</button>
                    <button type="button" class="cancel-btn" id="cancelProductModal">إلغاء</button>
                </div>
            </div>
        </div>

        <!-- ================ النافذة المنبثقة لإضافة/تعديل حساب منظومة ================ -->
        <div class="modal-overlay" id="systemAccountModalOverlay">
            <div class="modal" id="systemAccountModal">
                <div class="modal-header">
                    <h3 id="systemAccountModalTitle">إضافة حساب منظومة جديد</h3>
                    <button class="close-modal" id="closeSystemAccountModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-container">
                        <form id="systemAccountFormModal">
                            <input type="hidden" id="systemAccountEmailModal">
                            <div class="form-group">
                                <label for="systemAccountEmailInputModal">البريد الإلكتروني</label>
                                <input type="email" id="systemAccountEmailInputModal" required>
                            </div>
                            <div class="form-group">
                                <label for="systemAccountPasswordModal">كلمة المرور</label>
                                <input type="password" id="systemAccountPasswordModal" required minlength="6">
                            </div>
                            
                            <div class="form-group">
                                <h4>الصلاحيات</h4>
                                <div class="permissions-grid" id="permissionsGrid">
                                    <!-- سيتم إنشاء خانات اختيار للصلاحيات لكل قسم -->
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="submit-btn" id="saveSystemAccountModal">حفظ الحساب</button>
                    <button type="button" class="cancel-btn" id="cancelSystemAccountModal">إلغاء</button>
                    <button type="button" class="delete-btn hidden-by-permission" id="deleteSystemAccountModal" data-permission="systemAccounts.delete">حذف الحساب</button>
                </div>
            </div>
        </div>

        <!-- ================ النافذة المنبثقة لتعديل الحساب ================ -->
        <div class="modal-overlay" id="editAccountModalOverlay">
            <div class="modal" id="editAccountModal">
                <div class="modal-header">
                    <h3 id="editAccountModalTitle">تعديل حساب المستخدم</h3>
                    <button class="close-modal" id="closeEditAccountModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-container">
                        <form id="editAccountFormModal">
                            <input type="hidden" id="editAccountEmailModal">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editAccountFirstNameModal">الاسم الأول</label>
                                    <input type="text" id="editAccountFirstNameModal" required>
                                </div>
                                <div class="form-group">
                                    <label for="editAccountLastNameModal">اسم العائلة</label>
                                    <input type="text" id="editAccountLastNameModal" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editAccountPhoneModal">رقم الهاتف</label>
                                <input type="tel" id="editAccountPhoneModal" pattern="[0-9]{10}" title="يجب أن يتكون رقم الهاتف من 10 خانات" required>
                            </div>
                            <div class="form-group">
                                <label for="editAccountPasswordModal">كلمة المرور (اترك فارغاً لعدم التعديل)</label>
                                    <input type="password" id="editAccountPasswordModal" placeholder="اترك فارغاً لعدم التعديل" minlength="8" title="يجب أن تتكون كلمة المرور من 8 خانات على الأقل">
                            </div>
                            
                            <div class="form-group">
                                <label>العناوين المحفوظة</label>
                                <div id="editAccountAddressesListModal">
                                    <!-- العناوين ستظهر هنا -->
                                </div>
                                <button type="button" class="action-btn" id="addAddressInEditModal" style="margin-top: 10px;">
                                    <i class="fas fa-plus"></i> إضافة عنوان
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="submit-btn" id="saveAccountModal">حفظ التعديلات</button>
                    <button type="button" class="cancel-btn" id="cancelEditAccountModal">إلغاء</button>
                    <button type="button" class="delete-btn" id="deleteAccountModal">حذف الحساب</button>
                </div>
            </div>
        </div>

        <!-- ================ النافذة المنبثقة لإضافة عنوان ================ -->
        <div class="modal-overlay" id="addAddressModalOverlay">
            <div class="modal" id="addAddressModal">
                <div class="modal-header">
                    <h3 id="addAddressModalTitle">إضافة عنوان جديد</h3>
                    <button class="close-modal" id="closeAddAddressModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-container">
                        <form id="addAddressFormModal">
                            <input type="hidden" id="addAddressForEmailModal">
                            <div class="form-group">
                                <label for="addAddressCityModal">المدينة</label>
                                <select id="addAddressCityModal" required>
                                    <option value="">اختر المدينة</option>
                                    <option value="بنغازي">بنغازي</option>
                                    <option value="طرابلس">طرابلس</option>
                                    <option value="مصراتة">مصراتة</option>
                                    <option value="الزاوية">الزاوية</option>
                                    <option value="الخمس">الخمس</option>
                                    <option value="زليتن">زليتن</option>
                                    <option value="سبها">سبها</option>
                                    <option value="غريان">غريان</option>
                                    <option value="درنة">درنة</option>
                                    <option value="البيضاء">البيضاء</option>
                                    <option value="اجدابيا">اجدابيا</option>
                                    <option value="الكفرة">الكفرة</option>
                                    <option value="سرت">سرت</option>
                                    <option value="بني وليد">بني وليد</option>
                                    <option value="ترهونة">ترهونة</option>
                                    <option value="مسلاتة">مسلاتة</option>
                                    <option value="غدامس">غدامس</option>
                                    <option value="الجفرة">الجفرة</option>
                                    <option value="الجبل الغربي">الجبل الغربي</option>
                                    <option value="الزنتان">الزنتان</option>
                                    <option value="العجيلات">العجيلات</option>
                                    <option value="صبراتة">صبراتة</option>
                                    <option value="العزيزية">العزيزية</option>
                                    <option value="تاجوراء">تاجوراء</option>
                                    <option value="شحات">شحات</option>
                                    <option value="طبرق">طبرق</option>
                                    <option value="الأبيار">الأبيار</option>
                                    <option value="القبة">القبة</option>
                                    <option value="مرادة">مرادة</option>
                                    <option value="سلوق">سلوق</option>
                                    <option value="قمينس">قمينس</option>
                                    <option value="زوارة">زوارة</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="addAddressDetailsModal">العنوان التفصيلي</label>
                                <textarea id="addAddressDetailsModal" required rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="submit-btn" id="saveAddressModal">حفظ العنوان</button>
                    <button type="button" class="cancel-btn" id="cancelAddAddressModal">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
// ============ Firebase Configuration and Initialization ============
// استخدام قاعدة البيانات الأصلية التي طلبتها
const firebaseConfig = {
    apiKey: "AIzaSyBTfiSaiISbKGy2vMpZe-TMQAg_sEiSLWE",
    authDomain: "info-center-e5adb.firebaseapp.com",
    projectId: "info-center-e5adb",
    storageBucket: "info-center-e5adb.firebasestorage.app",
    messagingSenderId: "445052804703",
    appId: "1:445052804703:web:e1da4b68f2158cbfa0c5ea",
    measurementId: "G-PRZLVPY524"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// ============ Helper functions to interact with Firestore ============
async function getFirestoreData(collectionName, defaultValue = []) {
    try {
        const snapshot = await db.collection(collectionName).get();
        if (snapshot.empty) return defaultValue;
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
        console.error(`Error getting ${collectionName}:`, error);
        return defaultValue;
    }
}

async function setFirestoreData(collectionName, data) {
    try {
        const batch = db.batch();
        const snapshot = await db.collection(collectionName).get();
        snapshot.forEach(doc => batch.delete(doc.ref));
        data.forEach(item => {
            const docRef = db.collection(collectionName).doc();
            batch.set(docRef, item);
        });
        await batch.commit();
    } catch (error) {
        console.error(`Error setting ${collectionName}:`, error);
    }
}

// ============ Realtime listener for orders ============
let unsubscribeOrders = null;

function listenToOrders() {
    if (unsubscribeOrders) {
        unsubscribeOrders();
    }
    
    unsubscribeOrders = db.collection("orders").onSnapshot((snapshot) => {
        snapshot.docChanges().forEach((change) => {
            if (change.type === "added" || change.type === "modified" || change.type === "removed") {
                loadOrdersFromSnapshot();
            }
        });
    }, (error) => {
        console.error("Error listening to orders:", error);
    });
}

async function loadOrdersFromSnapshot() {
    const snapshot = await db.collection("orders").get();
    orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    localStorage.setItem('adminOrders', JSON.stringify(orders));
    
    if (document.getElementById('ordersPage').classList.contains('active')) {
        loadOrders();
    }
    
    updateOrdersBadge();
}

// ============ Global variables ============
let products = [];
let categoriesWithImages = [];
let coupons = [];
let orders = [];
let sliderImages = [];
let users = [];
let systemAccounts = [];
let loggedInAccount = JSON.parse(localStorage.getItem('loggedInAccount')) || null;

let currentCategoryView = '';
let currentUserView = null;

// متغيرات للمواصفات المؤقتة
let tempSpecsModal = [];

// متغيرات للصور المؤقتة
let tempProductImages = [];
let currentEditingProductId = null;

// إعدادات الترقيم
const itemsPerPage = 20;
let currentProductsPage = 1;
let currentCategoryProductsPage = 1;
let currentOrdersPage = 1;
let currentUserOrdersPage = 1;
let currentAccountsPage = 1;
let currentSystemAccountsPage = 1;

// متغير لتخزين كائن Sortable للفئات
let categoriesSortable = null;

// ============ دالة لعرض مؤشر التحميل ومنع الضغط المتكرر ============
async function withLoading(button, asyncCallback) {
    if (!button) return;
    
    if (button.classList.contains('loading')) {
        return;
    }
    
    button.classList.add('loading');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    
    try {
        await asyncCallback();
    } finally {
        button.classList.remove('loading');
        button.innerHTML = originalText;
    }
}

// ============ Initialize System: load data from Firestore ============
document.addEventListener('DOMContentLoaded', async function() {
    await initializeSystem();
    setupEventListeners();
    setupModalListeners();
    
    checkLoginStatus();
});

async function initializeSystem() {
    products = await getFirestoreData('products');
    categoriesWithImages = await getFirestoreData('categories');
    coupons = await getFirestoreData('coupons');
    orders = await getFirestoreData('orders');
    sliderImages = await getFirestoreData('sliderImages');
    users = await getFirestoreData('users');
    systemAccounts = await getFirestoreData('systemAccounts');

    // ============ إضافة حساب افتراضي إذا لم يكن موجوداً ============
    const defaultAdminEmail = "admin@atlas.ly";
    const defaultAdminPassword = "admin123456";
    
    const defaultAccountExists = systemAccounts.some(acc => acc.email === defaultAdminEmail);
    
    if (!defaultAccountExists) {
        console.log("جاري إنشاء حساب المدير الافتراضي...");
        
        const fullPermissions = {
            products: { view: true, edit: true, delete: true },
            categories: { view: true, edit: true, delete: true },
            coupons: { view: true, edit: true, delete: true },
            orders: { view: true, edit: true, delete: true },
            slider: { view: true, edit: true, delete: true },
            accounts: { view: true, edit: true, delete: true },
            systemAccounts: { view: true, edit: true, delete: true }
        };
        
        const defaultAccount = {
            email: defaultAdminEmail,
            password: defaultAdminPassword,
            permissions: fullPermissions
        };
        
        systemAccounts.push(defaultAccount);
        
        try {
            await auth.createUserWithEmailAndPassword(defaultAdminEmail, defaultAdminPassword);
            console.log("تم إنشاء حساب المدير في Firebase Authentication بنجاح");
        } catch (error) {
            if (error.code === 'auth/email-already-in-use') {
                console.log("حساب المدير موجود بالفعل في Firebase Authentication");
            } else {
                console.error("خطأ في إنشاء حساب المدير:", error);
            }
        }
        
        await saveSystemAccountsToFirestore();
        console.log("تم إضافة حساب المدير الافتراضي إلى قاعدة البيانات");
    }

    listenToOrders();

    updateCustomerProducts();
    updateCustomerCategories();
    updateCustomerSlider();
}

async function saveProductsToFirestore() {
    await setFirestoreData('products', products);
    updateCustomerProducts();
}

async function saveCategoriesToFirestore() {
    await setFirestoreData('categories', categoriesWithImages);
    updateCustomerCategories();
    updateCustomerProducts();
}

async function saveCouponsToFirestore() {
    await setFirestoreData('coupons', coupons);
}

async function saveOrdersToFirestore() {
    await setFirestoreData('orders', orders);
}

async function saveSliderToFirestore() {
    await setFirestoreData('sliderImages', sliderImages);
    updateCustomerSlider();
}

async function saveUsersToFirestore() {
    await setFirestoreData('users', users);
}

async function saveSystemAccountsToFirestore() {
    await setFirestoreData('systemAccounts', systemAccounts);
}

// ============ Check login status ============
function checkLoginStatus() {
    if (!loggedInAccount) {
        showLoginScreen();
    } else {
        showAdminSystem();
        setupNavigation();
        loadProducts();
        loadCategories();
        loadCoupons();
        loadOrders();
        loadSliderImages();
        loadAccounts();
        loadSystemAccounts();
        updateOrdersBadge();
        applyPermissions();
    }
}

function showLoginScreen() {
    document.getElementById('loginOverlay').style.display = 'flex';
    document.getElementById('adminSystem').style.display = 'none';
    
    const loginEmailSelect = document.getElementById('loginEmail');
    loginEmailSelect.innerHTML = '<option value="">اختر الحساب من القائمة</option>';
    systemAccounts.forEach(account => {
        loginEmailSelect.innerHTML += `<option value="${account.email}">${account.email}</option>`;
    });
}

function showAdminSystem() {
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('adminSystem').style.display = 'block';
}

document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    await login();
});

async function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const loginError = document.getElementById('loginError');
    
    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const account = systemAccounts.find(acc => acc.email === email);
        if (account) {
            loggedInAccount = {
                email: account.email,
                permissions: account.permissions
            };
            localStorage.setItem('loggedInAccount', JSON.stringify(loggedInAccount));
            
            loginError.style.display = 'none';
            showAdminSystem();
            setupNavigation();
            loadProducts();
            loadCategories();
            loadCoupons();
            loadOrders();
            loadSliderImages();
            loadAccounts();
            loadSystemAccounts();
            updateOrdersBadge();
            applyPermissions();
        } else {
            loginError.style.display = 'block';
        }
    } catch (error) {
        console.error("Login error:", error);
        loginError.style.display = 'block';
    }
}

async function logout() {
    if (confirm('هل تريد تسجيل الخروج من النظام؟')) {
        await auth.signOut();
        localStorage.removeItem('loggedInAccount');
        loggedInAccount = null;
        showLoginScreen();
    }
}

// ============ وظائف تطبيق الصلاحيات ============
function applyPermissions() {
    if (!loggedInAccount) return;
    
    const permissions = loggedInAccount.permissions;
    
    document.querySelectorAll('.menu-item').forEach(item => {
        const page = item.getAttribute('data-page');
        if (page) {
            const permissionKey = getPermissionKeyFromPage(page);
            if (permissionKey && !permissions[permissionKey]?.view) {
                item.classList.add('hidden-by-permission');
            } else {
                item.classList.remove('hidden-by-permission');
            }
        }
    });
    
    document.querySelectorAll('[data-permission]').forEach(element => {
        const requiredPermission = element.getAttribute('data-permission');
        const [section, action] = requiredPermission.split('.');
        
        if (!permissions[section] || !permissions[section][action]) {
            element.classList.add('hidden-by-permission');
        } else {
            element.classList.remove('hidden-by-permission');
        }
    });
    
    document.querySelectorAll('.page').forEach(page => {
        const pageId = page.id;
        const permissionKey = getPermissionKeyFromPage(pageId);
        if (permissionKey && !permissions[permissionKey]?.view) {
            page.classList.add('hidden-by-permission');
        } else {
            page.classList.remove('hidden-by-permission');
        }
    });
}

function getPermissionKeyFromPage(pageId) {
    const pageMap = {
        'productsPage': 'products',
        'categoriesPage': 'categories',
        'couponsPage': 'coupons',
        'ordersPage': 'orders',
        'sliderPage': 'slider',
        'accountsPage': 'accounts',
        'systemAccountsPage': 'systemAccounts'
    };
    return pageMap[pageId];
}

function checkPermission(section, action) {
    if (!loggedInAccount) return false;
    return loggedInAccount.permissions[section] && loggedInAccount.permissions[section][action];
}

// ============ وظائف إدارة حسابات المنظومة ============
function loadSystemAccounts(searchTerm = '', page = 1) {
    const systemAccountsGrid = document.getElementById('systemAccountsGrid');
    const noSystemAccountsMessage = document.getElementById('noSystemAccountsMessage');
    if (!systemAccountsGrid) return;
    
    systemAccountsGrid.innerHTML = '';
    
    currentSystemAccountsPage = page;
    
    const filteredAccounts = systemAccounts.filter(account => 
        account.email.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    if (filteredAccounts.length === 0) {
        systemAccountsGrid.style.display = 'none';
        if (noSystemAccountsMessage) {
            noSystemAccountsMessage.style.display = 'block';
        }
        const systemAccountsPagination = document.getElementById('systemAccountsPagination');
        if (systemAccountsPagination) {
            systemAccountsPagination.style.display = 'none';
        }
    } else {
        systemAccountsGrid.style.display = 'grid';
        if (noSystemAccountsMessage) {
            noSystemAccountsMessage.style.display = 'none';
        }
        
        filteredAccounts.forEach(account => {
            const accountCard = createSystemAccountCard(account);
            systemAccountsGrid.appendChild(accountCard);
        });
    }
}

function createSystemAccountCard(account) {
    const card = document.createElement('div');
    card.className = 'system-account-card';
    
    const emailParts = account.email.split('@')[0];
    const avatarText = emailParts.substring(0, 2).toUpperCase();
    
    const permissionsSummary = generatePermissionsSummary(account.permissions);
    
    const isCurrentAccount = loggedInAccount && loggedInAccount.email === account.email;
    
    card.innerHTML = `
        <div class="system-account-card-header">
            <div class="system-account-avatar">${avatarText}</div>
            <div class="system-account-info-summary">
                <div class="system-account-name">${account.email}</div>
                <div class="system-account-email">${isCurrentAccount ? '<i class="fas fa-user-check"></i> أنت' : 'حساب منظومة'}</div>
            </div>
        </div>
        <div class="system-account-card-body">
            <div class="system-account-details">
                <div class="system-account-detail-item">
                    <span class="system-account-detail-label">البريد الإلكتروني:</span>
                    <span class="system-account-detail-value">${account.email}</span>
                </div>
                <div class="system-account-detail-item">
                    <span class="system-account-detail-label">نوع الحساب:</span>
                    <span class="system-account-detail-value">${isCurrentAccount ? 'مسجل دخول حالياً' : 'حساب منظومة'}</span>
                </div>
            </div>
            <div class="permission-summary">
                <strong>الصلاحيات:</strong><br>
                ${permissionsSummary}
            </div>
        </div>
        <div class="system-account-card-footer">
            ${isCurrentAccount ? '' : `
                <button class="action-btn edit-btn edit-system-account-btn" data-email="${account.email}">تعديل</button>
                <button class="action-btn delete-btn delete-system-account-btn" data-email="${account.email}">حذف</button>
            `}
        </div>
    `;
    return card;
}

function generatePermissionsSummary(permissions) {
    let summary = '';
    const sections = {
        products: 'المنتجات',
        categories: 'الفئات',
        coupons: 'الكوبونات',
        orders: 'الطلبات',
        slider: 'السلايدر',
        accounts: 'حسابات العملاء',
        systemAccounts: 'حسابات المنظومة'
    };
    
    Object.keys(sections).forEach(section => {
        if (permissions[section]) {
            const perm = permissions[section];
            let permText = '';
            if (perm.view) permText += 'رؤية ';
            if (perm.edit) permText += 'تعديل ';
            if (perm.delete) permText += 'حذف ';
            if (permText) {
                summary += `<span class="permission-tag">${sections[section]}: ${permText}</span> `;
            }
        }
    });
    
    return summary || 'لا توجد صلاحيات';
}

function openAddSystemAccountModal() {
    const modalTitle = document.getElementById('systemAccountModalTitle');
    const form = document.getElementById('systemAccountFormModal');
    const deleteBtn = document.getElementById('deleteSystemAccountModal');
    
    modalTitle.textContent = 'إضافة حساب منظومة جديد';
    form.reset();
    deleteBtn.style.display = 'none';
    
    createPermissionCheckboxes();
    
    document.getElementById('systemAccountModalOverlay').classList.add('active');
}

function openEditSystemAccountModal(email) {
    const account = systemAccounts.find(acc => acc.email === email);
    if (!account) return;
    
    const modalTitle = document.getElementById('systemAccountModalTitle');
    const emailInput = document.getElementById('systemAccountEmailInputModal');
    const emailHidden = document.getElementById('systemAccountEmailModal');
    const passwordInput = document.getElementById('systemAccountPasswordModal');
    const deleteBtn = document.getElementById('deleteSystemAccountModal');
    const form = document.getElementById('systemAccountFormModal');
    
    modalTitle.textContent = `تعديل حساب ${email}`;
    emailHidden.value = email;
    emailInput.value = email;
    emailInput.readOnly = true;
    emailInput.style.backgroundColor = '#f8f9fa';
    passwordInput.placeholder = 'اترك فارغاً للحفاظ على كلمة المرور الحالية';
    passwordInput.required = false;
    deleteBtn.style.display = 'block';
    
    createPermissionCheckboxes(account.permissions);
    
    document.getElementById('systemAccountModalOverlay').classList.add('active');
}

function createPermissionCheckboxes(existingPermissions = null) {
    const permissionsGrid = document.getElementById('permissionsGrid');
    permissionsGrid.innerHTML = '';
    
    const sections = [
        { key: 'products', name: 'المنتجات' },
        { key: 'categories', name: 'الفئات' },
        { key: 'coupons', name: 'الكوبونات' },
        { key: 'orders', name: 'الطلبات' },
        { key: 'slider', name: 'السلايدر' },
        { key: 'accounts', name: 'حسابات العملاء' },
        { key: 'systemAccounts', name: 'حسابات المنظومة' }
    ];
    
    sections.forEach(section => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'permission-section';
        
        const permissions = existingPermissions ? existingPermissions[section.key] : { view: false, edit: false, delete: false };
        
        sectionDiv.innerHTML = `
            <h5>${section.name}</h5>
            <div class="permission-options">
                <div class="permission-option">
                    <input type="checkbox" id="perm_${section.key}_view" ${permissions.view ? 'checked' : ''}>
                    <label for="perm_${section.key}_view">رؤية</label>
                </div>
                <div class="permission-option">
                    <input type="checkbox" id="perm_${section.key}_edit" ${permissions.edit ? 'checked' : ''}>
                    <label for="perm_${section.key}_edit">تعديل/إضافة</label>
                </div>
                <div class="permission-option">
                    <input type="checkbox" id="perm_${section.key}_delete" ${permissions.delete ? 'checked' : ''}>
                    <label for="perm_${section.key}_delete">حذف</label>
                </div>
            </div>
        `;
        
        permissionsGrid.appendChild(sectionDiv);
    });
}

async function saveSystemAccount() {
    const emailHidden = document.getElementById('systemAccountEmailModal');
    const emailInput = document.getElementById('systemAccountEmailInputModal');
    const passwordInput = document.getElementById('systemAccountPasswordModal');
    
    const email = emailHidden.value || emailInput.value;
    const password = passwordInput.value;
    const isEditMode = !!emailHidden.value;
    
    if (!email || (!isEditMode && !password)) {
        alert('الرجاء إدخال البريد الإلكتروني وكلمة المرور');
        return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('الرجاء إدخال بريد إلكتروني صحيح');
        return;
    }
    
    if (!isEditMode && systemAccounts.some(acc => acc.email === email)) {
        alert('هذا البريد الإلكتروني موجود بالفعل');
        return;
    }
    
    const permissions = {};
    const sections = ['products', 'categories', 'coupons', 'orders', 'slider', 'accounts', 'systemAccounts'];
    
    sections.forEach(section => {
        permissions[section] = {
            view: document.getElementById(`perm_${section}_view`).checked,
            edit: document.getElementById(`perm_${section}_edit`).checked,
            delete: document.getElementById(`perm_${section}_delete`).checked
        };
    });
    
    try {
        if (isEditMode) {
            const index = systemAccounts.findIndex(acc => acc.email === email);
            if (index !== -1) {
                systemAccounts[index].permissions = permissions;
                if (password) {
                    systemAccounts[index].password = password;
                    const user = auth.currentUser;
                    if (user && user.email === email) {
                        await user.updatePassword(password);
                    }
                }
            }
        } else {
            const newAccount = {
                email: email,
                password: password,
                permissions: permissions
            };
            systemAccounts.push(newAccount);
            await auth.createUserWithEmailAndPassword(email, password);
        }
        
        await saveSystemAccountsToFirestore();
        
        closeSystemAccountModal();
        loadSystemAccounts();
        
        if (loggedInAccount && loggedInAccount.email === email) {
            loggedInAccount.permissions = permissions;
            localStorage.setItem('loggedInAccount', JSON.stringify(loggedInAccount));
            applyPermissions();
        }
        
        alert(`تم ${isEditMode ? 'تعديل' : 'إضافة'} الحساب بنجاح`);
    } catch (error) {
        console.error("Error saving system account:", error);
        alert("حدث خطأ أثناء حفظ الحساب: " + error.message);
    }
}

async function deleteSystemAccount() {
    const email = document.getElementById('systemAccountEmailModal').value;
    
    if (loggedInAccount && loggedInAccount.email === email) {
        alert('لا يمكنك حذف الحساب المسجل دخول به حالياً');
        return;
    }
    
    if (confirm(`هل أنت متأكد من حذف حساب ${email}؟`)) {
        try {
            systemAccounts = systemAccounts.filter(acc => acc.email !== email);
            await saveSystemAccountsToFirestore();
            
            closeSystemAccountModal();
            loadSystemAccounts();
            alert('تم حذف الحساب بنجاح');
        } catch (error) {
            console.error("Error deleting system account:", error);
            alert("حدث خطأ أثناء حذف الحساب");
        }
    }
}

function closeSystemAccountModal() {
    document.getElementById('systemAccountModalOverlay').classList.remove('active');
}

// ============ وظائف إدارة حسابات العملاء ============
function loadAccounts(searchTerm = '', page = 1) {
    const accountsGrid = document.getElementById('accountsGrid');
    const noAccountsMessage = document.getElementById('noAccountsMessage');
    if (!accountsGrid) return;
    
    accountsGrid.innerHTML = '';
    
    currentAccountsPage = page;
    
    const filteredUsers = users.filter(user => 
        `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (user.phone && user.phone.includes(searchTerm))
    );
    
    if (filteredUsers.length === 0) {
        accountsGrid.style.display = 'none';
        if (noAccountsMessage) {
            noAccountsMessage.style.display = 'block';
        }
        const accountsPagination = document.getElementById('accountsPagination');
        if (accountsPagination) {
            accountsPagination.style.display = 'none';
        }
    } else {
        accountsGrid.style.display = 'grid';
        if (noAccountsMessage) {
            noAccountsMessage.style.display = 'none';
        }
        
        const { startIndex, endIndex } = setupPagination(
            filteredUsers, 
            'accountsGrid', 
            'accountsPagination', 
            currentAccountsPage, 
            itemsPerPage,
            (newPage) => loadAccounts(searchTerm, newPage)
        );
        
        const usersToShow = filteredUsers.slice(startIndex, endIndex);
        
        usersToShow.forEach(user => {
            const accountCard = createAccountCard(user);
            accountsGrid.appendChild(accountCard);
        });
    }
    
    document.querySelectorAll('#accountsPage .edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const phone = this.getAttribute('data-phone');
            openEditAccountModal(phone);
        });
    });
    
    document.querySelectorAll('#accountsPage .delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const phone = this.getAttribute('data-phone');
            if (checkPermission('accounts', 'delete')) {
                if (confirm('هل أنت متأكد من حذف هذا الحساب؟')) {
                    deleteAccountByPhone(phone);
                }
            } else {
                alert('ليس لديك صلاحية لحذف حسابات العملاء');
            }
        });
    });
    
    document.querySelectorAll('#accountsPage .user-orders-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const phone = this.getAttribute('data-phone');
            viewUserOrders(phone);
        });
    });
    
    updateOrdersBadge();
}

function createAccountCard(user) {
    const card = document.createElement('div');
    card.className = 'account-card';
    
    const firstNameChar = user.firstName ? user.firstName.charAt(0) : 'U';
    const lastNameChar = user.lastName ? user.lastName.charAt(0) : 'S';
    const avatarText = firstNameChar + lastNameChar;
    
    const userOrders = orders.filter(order => order.customer && order.customer.phone === user.phone);
    const pendingOrders = userOrders.filter(order => order.status === 'pending').length;
    
    const addressesCount = user.addresses ? user.addresses.length : 0;
    
    let addressesHTML = '';
    if (user.addresses && user.addresses.length > 0) {
        const shortAddresses = user.addresses.slice(0, 2);
        shortAddresses.forEach(addr => {
            addressesHTML += `<div class="address-item-small">${addr.city || ''}: ${(addr.addressDetails || '').substring(0, 30)}${(addr.addressDetails || '').length > 30 ? '...' : ''}</div>`;
        });
        if (user.addresses.length > 2) {
            addressesHTML += `<div class="address-item-small">و ${user.addresses.length - 2} عنوان آخر</div>`;
        }
    } else {
        addressesHTML = '<div class="address-item-small">لا توجد عناوين</div>';
    }
    
    card.innerHTML = `
        <div class="account-card-header">
            <div class="account-avatar">${avatarText}</div>
            <div class="account-info-summary">
                <div class="account-name">${user.firstName || ''} ${user.lastName || ''}</div>
                <div class="account-phone">${user.phone || ''}</div>
            </div>
        </div>
        <div class="account-card-body">
            <div class="account-details">
                <div class="account-detail-item">
                    <span class="account-detail-label">عدد الطلبات:</span>
                    <span class="account-detail-value">${userOrders.length} طلب</span>
                </div>
                <div class="account-detail-item">
                    <span class="account-detail-label">طلبات معلقة:</span>
                    <span class="account-detail-value">${pendingOrders} طلب</span>
                </div>
                <div class="account-detail-item">
                    <span class="account-detail-label">عدد العناوين:</span>
                    <span class="account-detail-value">${addressesCount} عنوان</span>
                </div>
            </div>
            <div class="account-addresses">
                <strong>العناوين:</strong>
                ${addressesHTML}
            </div>
        </div>
        <div class="account-card-footer">
            <button class="user-orders-btn" data-phone="${user.phone || ''}">
                <i class="fas fa-box"></i> طلبات هذا الحساب
            </button>
            ${checkPermission('accounts', 'edit') ? `<button class="action-btn edit-btn" data-phone="${user.phone || ''}">تعديل</button>` : ''}
            ${checkPermission('accounts', 'delete') ? `<button class="action-btn delete-btn" data-phone="${user.phone || ''}">حذف</button>` : ''}
        </div>
    `;
    return card;
}

function openEditAccountModal(phone) {
    if (!checkPermission('accounts', 'edit')) {
        alert('ليس لديك صلاحية لتعديل حسابات العملاء');
        return;
    }
    
    const user = users.find(u => u.phone === phone);
    if (!user) {
        alert('لم يتم العثور على المستخدم');
        return;
    }
    
    currentUserView = user;
    
    const editAccountModalTitle = document.getElementById('editAccountModalTitle');
    const editAccountFirstNameModal = document.getElementById('editAccountFirstNameModal');
    const editAccountLastNameModal = document.getElementById('editAccountLastNameModal');
    const editAccountPhoneModal = document.getElementById('editAccountPhoneModal');
    const editAccountPasswordModal = document.getElementById('editAccountPasswordModal');
    
    if (editAccountModalTitle) {
        editAccountModalTitle.textContent = `تعديل حساب ${user.firstName || ''} ${user.lastName || ''}`;
    }
    if (editAccountFirstNameModal) {
        editAccountFirstNameModal.value = user.firstName || '';
    }
    if (editAccountLastNameModal) {
        editAccountLastNameModal.value = user.lastName || '';
    }
    if (editAccountPhoneModal) {
        editAccountPhoneModal.value = user.phone || '';
    }
    if (editAccountPasswordModal) {
        editAccountPasswordModal.value = '';
    }
    
    loadAddressesInEditModal(user.addresses || []);
    
    openEditAccountModalWindow();
}

function openEditAccountModalWindow() {
    const modalOverlay = document.getElementById('editAccountModalOverlay');
    if (modalOverlay) {
        modalOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function loadAddressesInEditModal(addresses) {
    const addressesList = document.getElementById('editAccountAddressesListModal');
    if (!addressesList) return;
    
    addressesList.innerHTML = '';
    
    if (!addresses || addresses.length === 0) {
        addressesList.innerHTML = '<p style="text-align: center; color: #777;">لا توجد عناوين مضافة.</p>';
        return;
    }
    
    addresses.forEach((address, index) => {
        const addressItem = document.createElement('div');
        addressItem.className = 'address-item-full';
        addressItem.innerHTML = `
            <strong>${address.city || ''}</strong>
            <p>${address.addressDetails || ''}</p>
            <div class="address-actions">
                ${checkPermission('accounts', 'edit') ? `<button class="action-btn delete-btn delete-address-btn" data-index="${index}">
                    <i class="fas fa-trash"></i> حذف
                </button>` : ''}
            </div>
        `;
        addressesList.appendChild(addressItem);
    });
    
    document.querySelectorAll('.delete-address-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            deleteAddressFromUser(index);
        });
    });
}

function deleteAddressFromUser(index) {
    if (!checkPermission('accounts', 'edit')) {
        alert('ليس لديك صلاحية لحذف عناوين العملاء');
        return;
    }
    
    if (!currentUserView) return;
    
    if (confirm('هل أنت متأكد من حذف هذا العنوان؟')) {
        currentUserView.addresses.splice(index, 1);
        loadAddressesInEditModal(currentUserView.addresses);
        
        const userIndex = users.findIndex(u => u.phone === currentUserView.phone);
        if (userIndex !== -1) {
            users[userIndex].addresses = currentUserView.addresses;
            saveUsersToFirestore();
        }
        
        alert('تم حذف العنوان بنجاح.');
    }
}

function closeEditAccountModal() {
    const modalOverlay = document.getElementById('editAccountModalOverlay');
    if (modalOverlay) {
        modalOverlay.classList.remove('active');
        document.body.style.overflow = 'auto';
        currentUserView = null;
    }
}

async function saveAccountChanges() {
    if (!checkPermission('accounts', 'edit')) {
        alert('ليس لديك صلاحية لحفظ تعديلات حسابات العملاء');
        return;
    }
    
    if (!currentUserView) return;
    
    const firstName = document.getElementById('editAccountFirstNameModal')?.value.trim();
    const lastName = document.getElementById('editAccountLastNameModal')?.value.trim();
    const phone = document.getElementById('editAccountPhoneModal')?.value.trim();
    const newPassword = document.getElementById('editAccountPasswordModal')?.value.trim();
    
    if (!firstName || !lastName || !phone) {
        alert('الرجاء ملء جميع الحقول المطلوبة.');
        return;
    }
    
    if (phone.length !== 10) {
        alert('رقم الهاتف يجب أن يتكون من 10 أرقام.');
        return;
    }
    
    if (newPassword && newPassword.length < 8) {
        alert('كلمة المرور الجديدة يجب أن تتكون من 8 أحرف على الأقل.');
        return;
    }
    
    const userIndex = users.findIndex(u => u.phone === currentUserView.phone);
    if (userIndex !== -1) {
        users[userIndex].firstName = firstName;
        users[userIndex].lastName = lastName;
        users[userIndex].phone = phone;
        
        if (newPassword) {
            users[userIndex].password = newPassword;
        }
        
        users[userIndex].addresses = currentUserView.addresses || [];
        
        await saveUsersToFirestore();
        
        orders.forEach(order => {
            if (order.customer && order.customer.phone === currentUserView.phone) {
                order.customer.name = `${firstName} ${lastName}`;
                order.customer.phone = phone;
            }
        });
        await saveOrdersToFirestore();
        
        alert('تم حفظ التعديلات بنجاح.');
        closeEditAccountModal();
        loadAccounts();
        loadOrders();
    }
}

async function deleteAccount() {
    if (!checkPermission('accounts', 'delete')) {
        alert('ليس لديك صلاحية لحذف حسابات العملاء');
        return;
    }
    
    if (!currentUserView) return;
    
    if (confirm(`هل أنت متأكد من حذف حساب ${currentUserView.firstName} ${currentUserView.lastName}؟ سيتم حذف جميع بياناته بما في ذلك الطلبات المرتبطة به.`)) {
        await deleteAccountByPhone(currentUserView.phone);
    }
}

async function deleteAccountByPhone(phone) {
    users = users.filter(u => u.phone !== phone);
    await saveUsersToFirestore();
    
    orders = orders.filter(order => order.customer && order.customer.phone !== phone);
    await saveOrdersToFirestore();
    
    alert('تم حذف الحساب بنجاح.');
    
    if (currentUserView && currentUserView.phone === phone) {
        closeEditAccountModal();
    }
    
    loadAccounts();
    loadOrders();
}

function viewUserOrders(phone) {
    const user = users.find(u => u.phone === phone);
    if (!user) return;
    
    currentUserView = user;
    currentUserOrdersPage = 1;
    
    const userInfoHeader = document.getElementById('userInfoHeader');
    if (userInfoHeader) {
        const firstNameChar = user.firstName ? user.firstName.charAt(0) : 'U';
        const lastNameChar = user.lastName ? user.lastName.charAt(0) : 'S';
        const avatarText = firstNameChar + lastNameChar;
        
        userInfoHeader.innerHTML = `
            <div class="user-avatar-large">${avatarText}</div>
            <div class="user-details-large">
                <div class="user-name-large">${user.firstName || ''} ${user.lastName || ''}</div>
                <div class="user-phone-large">${user.phone || ''}</div>
            </div>
        `;
    }
    
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    const userOrdersPage = document.getElementById('userOrdersPage');
    if (userOrdersPage) {
        userOrdersPage.classList.add('active');
    }
    
    loadUserOrders();
}

function loadUserOrders(searchTerm = '', page = 1) {
    const userOrdersList = document.getElementById('userOrdersList');
    if (!userOrdersList) return;
    
    userOrdersList.innerHTML = '';
    
    currentUserOrdersPage = page;
    
    if (!currentUserView) return;
    
    const userOrders = orders.filter(order => 
        order.customer && order.customer.phone === currentUserView.phone &&
        (order.id.toString().includes(searchTerm) ||
        (order.customer.name && order.customer.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (order.customer.phone && order.customer.phone.includes(searchTerm)))
    );
    
    userOrders.sort((a, b) => b.id - a.id);
    
    if (userOrders.length === 0) {
        userOrdersList.innerHTML = `
            <p style="text-align: center; padding: 20px;">
                <i class="fas fa-box-open" style="font-size: 24px; color: #ccc;"></i><br>
                لا توجد طلبات لهذا المستخدم.
            </p>
        `;
        const userOrdersPagination = document.getElementById('userOrdersPagination');
        if (userOrdersPagination) {
            userOrdersPagination.style.display = 'none';
        }
        return;
    }
    
    const { startIndex, endIndex } = setupPagination(
        userOrders, 
        'userOrdersList', 
        'userOrdersPagination', 
        currentUserOrdersPage, 
        itemsPerPage,
        (newPage) => loadUserOrders(searchTerm, newPage)
    );
    
    const ordersToShow = userOrders.slice(startIndex, endIndex);
    
    ordersToShow.forEach(order => {
        const orderCard = document.createElement('div');
        orderCard.className = 'order-card';
        
        let orderDetailsBoxes = '';
        order.items.forEach(item => {
            const currentProduct = products.find(p => p.id == item.id);
            const specsToDisplay = currentProduct ? currentProduct.specs : item.specs;
            const imageToDisplay = currentProduct ? (currentProduct.images ? currentProduct.images[0] : null) : item.image;
            
            let specsHTML = '';
            if (specsToDisplay && specsToDisplay.length > 0) {
                specsHTML = specsToDisplay.map(spec => 
                    `<div><span class="detail-label">${spec.label}:</span> ${spec.value}</div>`
                ).join('');
            }
            
            orderDetailsBoxes += `
                <div class="order-details-box">
                    <div><span class="detail-label">المنتج:</span></div>
                    <div>
                        <img src="${imageToDisplay || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkZGRkZGIi8+CjxyZWN0IHg9IjE1IiB5PSIxNSIgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0zNSAzNUw2NSAzNUw2NSA2NUwzNSA2NUwzNSAzNVoiIGZpbGw9IiNDQ0NDQ0MiLz4KPHBhdGggZD0iTTQyIDQyTDU4IDU4IiBzdHJva2U9IiM5Njk2OTYiIHN0cm9rZS13aWR0aD0iMS41Ii8+CjxwYXRoIGQ9Ik01OCA0Mkw0MiA1OCIgc3Ryb2tlPSIjOTY5Njk2IiBzdHJva2Utd2lkdGg9IjEuNSIvPgo8L3N2Zz4='}" alt="صورة المنتج" style="width: 100px; height: 100px; object-fit: contain; border-radius: 8px;">
                    </div>
                    <div><span class="detail-label">اسم المنتج:</span> ${item.name}</div>
                    <div><span class="detail-label">المواصفات:</span></div>
                    ${specsHTML}
                    <div><span class="detail-label">عدد القطع:</span> ${item.quantity}</div>
                </div>
            `;
        });
        
        let couponInfo = '';
        if (order.couponUsed) {
            couponInfo = `
                <div class="order-coupon-info">
                    <strong>كوبون مستخدم:</strong> تم تطبيق خصم بقيمة ${order.couponUsed.value} د.ل
                </div>
            `;
        }
        
        orderCard.innerHTML = `
            <div class="order-header">
                <div class="order-id">طلب رقم: #${order.id}</div>
                <div class="order-date">${order.date}</div>
            </div>
            <div class="order-customer">
                <div><strong>العميل:</strong> ${order.customer.name || ''}</div>
                <div><strong>الهاتف:</strong> ${order.customer.phone || ''}</div>
                <div><strong>المدينة:</strong> ${order.customer.city || ''}</div>
                <div><strong>العنوان:</strong> ${order.customer.address || ''}</div>
                ${order.deliveryMethod ? `<div><strong>طريقة الاستلام:</strong> ${order.deliveryMethod === 'delivery' ? 'توصيل' : 'حجز'}</div>` : ''}
                ${order.notes ? `<div><strong>ملاحظات:</strong> ${order.notes}</div>` : ''}
            </div>
            ${couponInfo}
            ${orderDetailsBoxes}
            <div class="order-footer">
                <div class="order-total">المجموع: ${order.total} د.ل</div>
                <div class="order-status-select-container">
                    <select class="order-status-select ${order.status}" data-id="${order.id}">
                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>قيد الانتظار</option>
                        <option value="approved" ${order.status === 'approved' ? 'selected' : ''}>تمت الموافقة</option>
                        <option value="rejected" ${order.status === 'rejected' ? 'selected' : ''}>تم الرفض</option>
                    </select>
                    ${checkPermission('orders', 'edit') ? `<button class="update-status-btn" data-id="${order.id}">تحديث الحالة</button>` : ''}
                    ${checkPermission('orders', 'delete') ? `<button class="delete-order-btn" data-id="${order.id}">حذف الطلب</button>` : ''}
                </div>
            </div>
        `;
        userOrdersList.appendChild(orderCard);
    });
    
    document.querySelectorAll('#userOrdersPage .order-status-select').forEach(select => {
        select.addEventListener('change', function() {
            this.className = `order-status-select ${this.value}`;
        });
    });
    
    document.querySelectorAll('#userOrdersPage .update-status-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = parseInt(this.getAttribute('data-id'));
            const select = document.querySelector(`.order-status-select[data-id="${orderId}"]`);
            const newStatus = select.value;
            withLoading(this, () => updateOrderStatus(orderId, newStatus));
        });
    });
    
    document.querySelectorAll('#userOrdersPage .delete-order-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.getAttribute('data-id');
            deleteOrder(orderId);
        });
    });
}

function openAddAddressModal() {
    const addAddressCityModal = document.getElementById('addAddressCityModal');
    const addAddressDetailsModal = document.getElementById('addAddressDetailsModal');
    
    if (addAddressCityModal) addAddressCityModal.value = '';
    if (addAddressDetailsModal) addAddressDetailsModal.value = '';
    
    const addAddressForEmailModal = document.getElementById('addAddressForEmailModal');
    if (addAddressForEmailModal && currentUserView) {
        addAddressForEmailModal.value = currentUserView.phone;
    }
    
    const modalOverlay = document.getElementById('addAddressModalOverlay');
    if (modalOverlay) {
        modalOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function closeAddAddressModal() {
    const modalOverlay = document.getElementById('addAddressModalOverlay');
    if (modalOverlay) {
        modalOverlay.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

async function saveAddress() {
    if (!checkPermission('accounts', 'edit')) {
        alert('ليس لديك صلاحية لإضافة عناوين للعملاء');
        return;
    }
    
    const city = document.getElementById('addAddressCityModal')?.value.trim();
    const addressDetails = document.getElementById('addAddressDetailsModal')?.value.trim();
    const phone = document.getElementById('addAddressForEmailModal')?.value;
    
    if (!city || !addressDetails) {
        alert('الرجاء ملء جميع الحقول.');
        return;
    }
    
    const newAddress = { city, addressDetails };
    
    if (currentUserView) {
        if (!currentUserView.addresses) {
            currentUserView.addresses = [];
        }
        currentUserView.addresses.push(newAddress);
        
        const userIndex = users.findIndex(u => u.phone === phone);
        if (userIndex !== -1) {
            if (!users[userIndex].addresses) {
                users[userIndex].addresses = [];
            }
            users[userIndex].addresses.push(newAddress);
            await saveUsersToFirestore();
        }
        
        loadAddressesInEditModal(currentUserView.addresses);
        
        alert('تم إضافة العنوان بنجاح.');
        closeAddAddressModal();
    }
}

// ============ وظائف إدارة المنتجات ============
function loadProducts(searchTerm = '', page = 1) {
    const productsGrid = document.getElementById('productsGrid');
    const noProductsMessage = document.getElementById('noProductsMessage');
    if (!productsGrid) return;

    productsGrid.innerHTML = '';
    currentProductsPage = page;

    let filteredProducts = products.filter(product => 
        product.name && product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (product.category && product.category.toLowerCase().includes(searchTerm.toLowerCase()))
    );

    if (filteredProducts.length === 0) {
        if (noProductsMessage) noProductsMessage.style.display = 'block';
        const productsPagination = document.getElementById('productsPagination');
        if (productsPagination) productsPagination.style.display = 'none';
    } else {
        if (noProductsMessage) noProductsMessage.style.display = 'none';

        const { startIndex, endIndex } = setupPagination(
            filteredProducts, 
            'productsGrid', 
            'productsPagination', 
            currentProductsPage, 
            itemsPerPage,
            (newPage) => loadProducts(searchTerm, newPage)
        );

        const productsToShow = filteredProducts.slice(startIndex, endIndex);

        productsToShow.forEach(product => {
            const card = createProductCard(product);
            productsGrid.appendChild(card);
        });
    }

    document.querySelectorAll('#productsPage .edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-id'));
            openEditProductModal(productId);
        });
    });

    document.querySelectorAll('#productsPage .delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-id'));
            if (checkPermission('products', 'delete')) {
                deleteProduct(productId);
            } else {
                alert('ليس لديك صلاحية لحذف المنتجات');
            }
        });
    });
}

function createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.dataset.id = product.id;

    let quantityClass = 'quantity-ok';
    let quantityStatus = `${product.quantity || 0} قطعة`;
    if (product.quantity <= 0) {
        quantityClass = 'quantity-out';
        quantityStatus = 'نفذت الكمية';
    } else if (product.quantity <= 5) {
        quantityClass = 'quantity-low';
    }

    const imageUrl = product.images && product.images[0] ? product.images[0] : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIGZpbGw9IiNGMEYwRjAiLz48cGF0aCBkPSJNMjAgMjBMNDAgMjBMNDAgNDBMMjAgNDBMMjAgMjBaIiBmaWxsPSIjQ0NDQ0NDIi8+PHBhdGggZD0iTTI1IDI1TDM1IDM1IiBzdHJva2U9IiM5OTkiIHN0cm9rZS13aWR0aD0iMS41Ii8+PHBhdGggZD0iTTM1IDI1TDI1IDM1IiBzdHJva2U9IiM5OTkiIHN0cm9rZS13aWR0aD0iMS41Ii8+PC9zdmc+';

    card.innerHTML = `
        <div class="category-details">
            <div class="category-image-thumb" style="background-image: url('${imageUrl}');"></div>
            <div class="product-info">
                <span class="product-name">${product.name || ''}</span>
                <div class="product-meta">
                    <span><i class="fas fa-tag"></i> ${product.category || ''}</span>
                    <span><i class="fas fa-dollar-sign"></i> ${product.sellPrice || 0} د.ل</span>
                    <span><i class="fas fa-box"></i> <span class="quantity-display ${quantityClass}">${quantityStatus}</span></span>
                    <span><i class="fas fa-images"></i> ${product.images ? product.images.length : 0}</span>
                    ${product.timer && product.timer.enabled ? `<span><i class="fas fa-clock"></i> ${product.timer.hours || 0}:${product.timer.minutes || 0}</span>` : ''}
                    ${product.discount && product.discount.enabled ? `<span><i class="fas fa-percentage"></i> ${product.discount.percentage}%</span>` : ''}
                </div>
                ${product.specs && product.specs.length > 0 ? 
                    `<div class="product-specs"><i class="fas fa-info-circle"></i> ${product.specs.map(s => `${s.label}: ${s.value}`).join(' - ')}</div>` : ''}
            </div>
        </div>
        <div class="category-actions">
            ${checkPermission('products', 'edit') ? `<button class="action-btn edit-btn" data-id="${product.id}"><i class="fas fa-edit"></i> تعديل</button>` : ''}
            ${checkPermission('products', 'delete') ? `<button class="action-btn delete-btn" data-id="${product.id}"><i class="fas fa-trash"></i> حذف</button>` : ''}
        </div>
    `;
    return card;
}

function addProduct() {
    if (!checkPermission('products', 'edit')) {
        alert('ليس لديك صلاحية لإضافة منتجات');
        return;
    }

    const productModalTitle = document.getElementById('productModalTitle');
    const productIdModal = document.getElementById('productIdModal');
    const productFormModal = document.getElementById('productFormModal');
    const timerInputsModal = document.getElementById('timerInputsModal');
    const discountInputModal = document.getElementById('discountInputModal');
    const quantityWarning = document.getElementById('quantityWarning');

    if (productModalTitle) productModalTitle.textContent = 'إضافة منتج جديد';
    if (productIdModal) productIdModal.value = '';
    if (productFormModal) productFormModal.reset();
    if (timerInputsModal) timerInputsModal.style.display = 'none';
    if (discountInputModal) discountInputModal.style.display = 'none';
    if (quantityWarning) quantityWarning.style.display = 'none';

    tempProductImages = [];
    displayImagesGrid();

    tempSpecsModal = [];
    renderSpecsListModal();

    const categorySelect = document.getElementById('productCategoryModal');
    if (categorySelect) {
        categorySelect.innerHTML = '<option value="">اختر الفئة</option>';
        categoriesWithImages.forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
        });
    }

    currentEditingProductId = null;
    openProductModal();
}

async function openEditProductModal(productId) {
    if (!checkPermission('products', 'edit')) {
        alert('ليس لديك صلاحية لتعديل المنتجات');
        return;
    }

    const product = products.find(p => p.id == productId);
    if (!product) return;

    currentEditingProductId = productId;

    const productModalTitle = document.getElementById('productModalTitle');
    const productIdModal = document.getElementById('productIdModal');
    const productNameModal = document.getElementById('productNameModal');
    const categorySelect = document.getElementById('productCategoryModal');
    const productCostPriceModal = document.getElementById('productCostPriceModal');
    const productSellPriceModal = document.getElementById('productSellPriceModal');
    const productQuantityModal = document.getElementById('productQuantityModal');
    const generalDescriptionModal = document.getElementById('generalDescriptionModal');
    const quantityWarning = document.getElementById('quantityWarning');

    if (productModalTitle) productModalTitle.textContent = 'تعديل المنتج';
    if (productIdModal) productIdModal.value = product.id;
    if (productNameModal) productNameModal.value = product.name || '';

    if (categorySelect) {
        categorySelect.innerHTML = '<option value="">اختر الفئة</option>';
        categoriesWithImages.forEach(cat => {
            const selected = cat.name === product.category ? 'selected' : '';
            categorySelect.innerHTML += `<option value="${cat.name}" ${selected}>${cat.name}</option>`;
        });
    }

    if (productCostPriceModal) productCostPriceModal.value = product.costPrice || 0;
    if (productSellPriceModal) productSellPriceModal.value = product.sellPrice || 0;
    if (productQuantityModal) productQuantityModal.value = product.quantity || 0;
    if (generalDescriptionModal) generalDescriptionModal.value = product.generalDescription || '';

    if (quantityWarning) {
        if (product.quantity <= 0) {
            quantityWarning.style.display = 'flex';
        } else {
            quantityWarning.style.display = 'none';
        }
    }

    tempProductImages = [];
    if (product.images && product.images.length > 0) {
        product.images.forEach(img => {
            tempProductImages.push({ url: img, isNew: false });
        });
    }
    displayImagesGrid();

    tempSpecsModal = product.specs || [];
    renderSpecsListModal();

    const enableTimerModal = document.getElementById('enableTimerModal');
    const timerHoursModal = document.getElementById('timerHoursModal');
    const timerMinutesModal = document.getElementById('timerMinutesModal');
    const timerInputsModal = document.getElementById('timerInputsModal');

    if (product.timer) {
        if (enableTimerModal) enableTimerModal.checked = product.timer.enabled || false;
        if (timerHoursModal) timerHoursModal.value = product.timer.hours || 0;
        if (timerMinutesModal) timerMinutesModal.value = product.timer.minutes || 0;
        if (timerInputsModal) timerInputsModal.style.display = product.timer.enabled ? 'flex' : 'none';
    } else {
        if (enableTimerModal) enableTimerModal.checked = false;
        if (timerInputsModal) timerInputsModal.style.display = 'none';
    }

    const enableDiscountModal = document.getElementById('enableDiscountModal');
    const discountPercentageModal = document.getElementById('discountPercentageModal');
    const discountInputModal = document.getElementById('discountInputModal');

    if (product.discount) {
        if (enableDiscountModal) enableDiscountModal.checked = product.discount.enabled || false;
        if (discountPercentageModal) discountPercentageModal.value = product.discount.percentage || 10;
        if (discountInputModal) discountInputModal.style.display = product.discount.enabled ? 'block' : 'none';
    } else {
        if (enableDiscountModal) enableDiscountModal.checked = false;
        if (discountInputModal) discountInputModal.style.display = 'none';
    }

    openProductModal();
}

function openProductModal() {
    const modalOverlay = document.getElementById('productModalOverlay');
    if (modalOverlay) {
        modalOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function closeProductModal() {
    const modalOverlay = document.getElementById('productModalOverlay');
    if (modalOverlay) {
        modalOverlay.classList.remove('active');
        document.body.style.overflow = 'auto';
        tempProductImages = [];
        currentEditingProductId = null;
    }
}

async function saveProduct() {
    if (!checkPermission('products', 'edit')) {
        alert('ليس لديك صلاحية لحفظ المنتجات');
        return;
    }

    const productId = document.getElementById('productIdModal')?.value;
    const name = document.getElementById('productNameModal')?.value;
    const category = document.getElementById('productCategoryModal')?.value;
    const costPrice = parseFloat(document.getElementById('productCostPriceModal')?.value);
    const sellPrice = parseFloat(document.getElementById('productSellPriceModal')?.value);
    const quantity = parseInt(document.getElementById('productQuantityModal')?.value) || 0;
    const generalDescription = document.getElementById('generalDescriptionModal')?.value;

    if (!name || !category || isNaN(costPrice) || isNaN(sellPrice) || isNaN(quantity) || quantity < 0) {
        alert('الرجاء ملء جميع الحقول بشكل صحيح. الكمية يجب أن تكون 0 أو أكثر.');
        return;
    }

    const images = [];

    const newImages = tempProductImages.filter(img => img.isNew);
    for (const img of newImages) {
        try {
            const compressedImage = await compressImage(img.url);
            images.push(compressedImage);
        } catch (error) {
            console.error('Error compressing image:', error);
            images.push(img.url);
        }
    }

    const existingImages = tempProductImages.filter(img => !img.isNew);
    existingImages.forEach(img => {
        images.push(img.url);
    });

    if (images.length === 0) {
        images.push('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRkZGRkZGIi8+CjxyZWN0IHg9IjUwIiB5PSI1MCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNGMEYwRjAiLz4KPHBhdGggZD0iTTEwMCAxMDBMMjAwIDEwMEwyMDAgMjAwTDEwMCAyMDBMMTAwIDEwMFoiIGZpbGw9IiNDQ0NDQ0MiLz4KPHBhdGggZD0iTTEyNSAxMjVMMTc1IDE3NSIgc3Ryb2tlPSIjOTY5Njk2IiBzdHJva2Utd2lkdGg9IjIiLz4KPHBhdGggZD0iTTE3NSAxMjVMMTI1IDE3NSIgc3Ryb2tlPSIjOTY5Njk2IiBzdHJva2Utd2lkdGg9IjIiLz4KPC9zdmc+');
    }

    const timerEnabled = document.getElementById('enableTimerModal')?.checked || false;
    const timerHours = parseInt(document.getElementById('timerHoursModal')?.value) || 0;
    const timerMinutes = parseInt(document.getElementById('timerMinutesModal')?.value) || 0;

    const discountEnabled = document.getElementById('enableDiscountModal')?.checked || false;
    const discountPercentage = parseInt(document.getElementById('discountPercentageModal')?.value) || 10;

    const now = new Date().getTime();

    if (productId) {
        const index = products.findIndex(p => p.id == productId);
        if (index !== -1) {
            products[index] = {
                ...products[index],
                name,
                category,
                costPrice,
                sellPrice,
                quantity,
                generalDescription,
                specs: [...tempSpecsModal],
                images: images,
                timer: {
                    enabled: timerEnabled,
                    hours: timerHours,
                    minutes: timerMinutes
                },
                discount: {
                    enabled: discountEnabled,
                    percentage: discountPercentage
                },
                updatedAt: now
            };
        }
    } else {
        const newProduct = {
            id: Date.now(),
            name,
            category,
            costPrice,
            sellPrice,
            quantity,
            generalDescription,
            specs: [...tempSpecsModal],
            images: images,
            timer: {
                enabled: timerEnabled,
                hours: timerHours,
                minutes: timerMinutes
            },
            discount: {
                enabled: discountEnabled,
                percentage: discountPercentage
            },
            createdAt: now,
            updatedAt: now
        };
        products.unshift(newProduct);
    }

    await saveProductsToFirestore();

    closeProductModal();

    if (currentCategoryView) {
        loadCategoryProducts();
    } else {
        loadProducts();
    }

    alert('تم حفظ المنتج بنجاح!');
}

async function deleteProduct(productId) {
    if (!checkPermission('products', 'delete')) {
        alert('ليس لديك صلاحية لحذف المنتجات');
        return;
    }

    if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
        products = products.filter(p => p.id != productId);
        await saveProductsToFirestore();

        if (currentCategoryView) {
            loadCategoryProducts();
        } else {
            loadProducts();
        }

        alert('تم حذف المنتج بنجاح!');
    }
}

// ============ وظائف إدارة الفئات مع حفظ الترتيب يدوياً ============
function loadCategories() {
    const categoriesList = document.getElementById('categoriesList');
    if (!categoriesList) return;
    
    categoriesList.innerHTML = '';
    
    categoriesWithImages.forEach(cat => {
        const categoryItem = document.createElement('li');
        categoryItem.className = 'category-item';
        categoryItem.setAttribute('draggable', 'true');
        categoryItem.dataset.name = cat.name;

        const eyeIconClass = cat.visible ? 'fa-eye' : 'fa-eye-slash';
        const eyeBtnClass = cat.visible ? '' : 'hidden';

        categoryItem.innerHTML = `
            <div class="category-details">
                <i class="fas fa-ellipsis-v drag-handle"></i>
                <div class="category-image-thumb" style="background-image: url('${cat.imageURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRkZGRkZGIi8+CjxyZWN0IHg9IjUwIiB5PSI1MCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNGMEYwRjAiLz4KPHBhdGggZD0iTTEwMCAxMDBMMjAwIDEwMEwyMDAgMjAwTDEwMCAyMDBMMTAwIDEwMFoiIGZpbGw9IiNDQ0NDQ0MiLz4KPHBhdGggZD0iTTEyNSAxMjVMMTc1IDE3NSIgc3Ryb2tlPSIjOTY5Njk2IiBzdHJva2Utd2lkdGg9IjIiLz4KPHBhdGggZD0iTTE3NSAxMjVMMTI1IDE3NSIgc3Ryb2tlPSIjOTY5Njk2IiBzdHJva2Utd2lkdGg9IjIiLz4KPC9zdmc+'})"></div>
                <span class="category-name-display">${cat.name}</span>
            </div>
            <div class="category-actions">
                <button class="toggle-visibility-btn ${eyeBtnClass}" data-name="${cat.name}">
                    <i class="fas ${eyeIconClass}"></i>
                </button>
                <button class="view-products-btn" data-name="${cat.name}">عرض المنتجات</button>
                ${checkPermission('categories', 'edit') ? `<button class="action-btn edit-btn" data-name="${cat.name}">تعديل</button>` : ''}
                ${checkPermission('categories', 'delete') ? `<button class="action-btn delete-btn" data-name="${cat.name}">حذف</button>` : ''}
            </div>
        `;
        categoriesList.appendChild(categoryItem);
    });
    
    // إنشاء كائن Sortable جديد
    if (typeof Sortable !== 'undefined') {
        if (categoriesSortable) {
            categoriesSortable.destroy();
        }
        
        categoriesSortable = new Sortable(categoriesList, {
            animation: 150,
            handle: '.drag-handle',
            // لا نقوم بالحفظ التلقائي هنا، سيتم الحفظ فقط عند الضغط على زر حفظ ترتيب الفئات
        });
    }

    document.querySelectorAll('#categoriesPage .edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const name = this.getAttribute('data-name');
            editCategory(name);
        });
    });

    document.querySelectorAll('#categoriesPage .delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const name = this.getAttribute('data-name');
            deleteCategory(name);
        });
    });

    document.querySelectorAll('.toggle-visibility-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const name = this.getAttribute('data-name');
            await toggleCategoryVisibility(name);
        });
    });
    
    document.querySelectorAll('.view-products-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const categoryName = this.getAttribute('data-name');
            viewCategoryProducts(categoryName);
        });
    });
}

// دالة حفظ ترتيب الفئات - معدلة للتأكد من الحفظ الصحيح
async function saveCategoriesOrder() {
    if (!checkPermission('categories', 'edit')) {
        alert('ليس لديك صلاحية لتعديل الفئات');
        return;
    }
    
    // الحصول على الترتيب الجديد من DOM
    const categoriesList = document.getElementById('categoriesList');
    const categoryItems = categoriesList.querySelectorAll('.category-item');
    const newOrder = [];
    
    categoryItems.forEach(item => {
        const name = item.dataset.name;
        const category = categoriesWithImages.find(c => c.name === name);
        if (category) {
            newOrder.push(category);
        }
    });
    
    // التأكد من أن الترتيب الجديد يحتوي على جميع الفئات
    if (newOrder.length !== categoriesWithImages.length) {
        console.warn('عدد الفئات في الترتيب الجديد لا يساوي العدد الأصلي');
    }
    
    // تحديث مصفوفة الفئات بالترتيب الجديد
    categoriesWithImages = newOrder;
    
    // حفظ في قاعدة البيانات
    await saveCategoriesToFirestore();
    
    alert('تم حفظ ترتيب الفئات بنجاح!');
}

function viewCategoryProducts(categoryName) {
    currentCategoryView = categoryName;
    currentCategoryProductsPage = 1;
    
    const currentCategoryTitle = document.getElementById('currentCategoryTitle');
    if (currentCategoryTitle) {
        currentCategoryTitle.textContent = categoryName;
    }
    
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    const categoryProductsPage = document.getElementById('categoryProductsPage');
    if (categoryProductsPage) {
        categoryProductsPage.classList.add('active');
    }
    
    loadCategoryProducts();
}

function loadCategoryProducts(searchTerm = '', page = 1) {
    const categoryProductsGrid = document.getElementById('categoryProductsGrid');
    const noCategoryProductsMessage = document.getElementById('noCategoryProductsMessage');
    if (!categoryProductsGrid) return;
    
    categoryProductsGrid.innerHTML = '';
    
    currentCategoryProductsPage = page;
    
    const categoryProducts = products.filter(product => 
        product.category === currentCategoryView &&
        (product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (product.generalDescription && product.generalDescription.toLowerCase().includes(searchTerm.toLowerCase())))
    );
    
    if (categoryProducts.length === 0) {
        if (noCategoryProductsMessage) {
            noCategoryProductsMessage.style.display = 'block';
        }
        const categoryProductsPagination = document.getElementById('categoryProductsPagination');
        if (categoryProductsPagination) {
            categoryProductsPagination.style.display = 'none';
        }
    } else {
        if (noCategoryProductsMessage) {
            noCategoryProductsMessage.style.display = 'none';
        }
        
        const { startIndex, endIndex } = setupPagination(
            categoryProducts, 
            'categoryProductsGrid', 
            'categoryProductsPagination', 
            currentCategoryProductsPage, 
            itemsPerPage,
            (newPage) => loadCategoryProducts(searchTerm, newPage)
        );
        
        const productsToShow = categoryProducts.slice(startIndex, endIndex);
        
        productsToShow.forEach(product => {
            const card = createProductCard(product);
            categoryProductsGrid.appendChild(card);
        });
    }
    
    document.querySelectorAll('#categoryProductsPage .edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-id'));
            openEditProductModal(productId);
        });
    });
    
    document.querySelectorAll('#categoryProductsPage .delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = parseInt(this.getAttribute('data-id'));
            if (checkPermission('products', 'delete')) {
                deleteProduct(productId);
            } else {
                alert('ليس لديك صلاحية لحذف المنتجات');
            }
        });
    });
}

async function toggleCategoryVisibility(name) {
    if (!checkPermission('categories', 'edit')) {
        alert('ليس لديك صلاحية لتعديل الفئات');
        return;
    }
    
    const categoryIndex = categoriesWithImages.findIndex(c => c.name === name);
    if (categoryIndex > -1) {
        categoriesWithImages[categoryIndex].visible = !categoriesWithImages[categoryIndex].visible;
        await saveCategoriesToFirestore();
        loadCategories();
    }
}

function addCategory() {
    if (!checkPermission('categories', 'edit')) {
        alert('ليس لديك صلاحية لإضافة فئات');
        return;
    }
    
    const categoryFormTitle = document.getElementById('categoryFormTitle');
    const categoryId = document.getElementById('categoryId');
    const categoryForm = document.getElementById('categoryForm');
    const categoryImagePreview = document.getElementById('categoryImagePreview');
    const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');
    
    if (categoryFormTitle) categoryFormTitle.textContent = 'إضافة فئة جديدة';
    if (categoryId) categoryId.value = '';
    if (categoryForm) categoryForm.reset();
    if (categoryImagePreview) categoryImagePreview.innerHTML = '';
    if (cancelCategoryBtn) cancelCategoryBtn.style.display = 'none';
}

async function editCategory(name) {
    if (!checkPermission('categories', 'edit')) {
        alert('ليس لديك صلاحية لتعديل الفئات');
        return;
    }
    
    const category = categoriesWithImages.find(cat => cat.name === name);
    if (!category) return;

    const categoryFormTitle = document.getElementById('categoryFormTitle');
    const categoryId = document.getElementById('categoryId');
    const categoryName = document.getElementById('categoryName');
    const categoryImagePreview = document.getElementById('categoryImagePreview');
    const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');
    
    if (categoryFormTitle) categoryFormTitle.textContent = 'تعديل الفئة';
    if (categoryId) categoryId.value = category.name;
    if (categoryName) categoryName.value = category.name;
    
    if (categoryImagePreview) {
        categoryImagePreview.innerHTML = '';
        if (category.imageURL) {
            const imgElement = document.createElement('img');
            imgElement.src = category.imageURL;
            imgElement.className = 'image-preview';
            categoryImagePreview.appendChild(imgElement);
        }
    }
    
    if (cancelCategoryBtn) cancelCategoryBtn.style.display = 'inline-block';
}

async function deleteCategory(name) {
    if (!checkPermission('categories', 'delete')) {
        alert('ليس لديك صلاحية لحذف الفئات');
        return;
    }
    
    if (confirm(`هل أنت متأكد من حذف الفئة "${name}"؟ سيتم حذف المنتجات المرتبطة بها أيضاً.`)) {
        categoriesWithImages = categoriesWithImages.filter(c => c.name !== name);
        
        products = products.filter(p => p.category !== name);
        
        await saveCategoriesToFirestore();
        await saveProductsToFirestore();
        
        loadCategories();
        
        if (currentCategoryView === name) {
            const categoryProductsPage = document.getElementById('categoryProductsPage');
            const categoriesPage = document.getElementById('categoriesPage');
            const categoriesMenu = document.querySelector('.menu-item[data-page="categoriesPage"]');
            
            if (categoryProductsPage) categoryProductsPage.classList.remove('active');
            if (categoriesPage) categoriesPage.classList.add('active');
            if (categoriesMenu) categoriesMenu.classList.add('active');
            currentCategoryView = '';
        }
        
        alert('تم حذف الفئة بنجاح!');
    }
}

async function saveCategory() {
    if (!checkPermission('categories', 'edit')) {
        alert('ليس لديك صلاحية لحفظ الفئات');
        return;
    }
    
    const name = document.getElementById('categoryName')?.value.trim();
    const categoryId = document.getElementById('categoryId')?.value;
    const imageFile = document.getElementById('categoryImageFile')?.files[0];
    
    if (!name) {
        alert('الرجاء إدخال اسم الفئة');
        return;
    }
    
    let imageURL = '';
    
    if (imageFile) {
        try {
            const base64Image = await fileToBase64(imageFile);
            imageURL = await compressImage(base64Image);
        } catch (error) {
            alert('حدث خطأ في معالجة الصورة. الرجاء المحاولة مرة أخرى.');
            return;
        }
    } else if (categoryId) {
        const existingCategory = categoriesWithImages.find(c => c.name === categoryId);
        if (existingCategory) {
            imageURL = existingCategory.imageURL;
        }
    }
    
    if (!imageURL) {
        imageURL = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRkZGRkZGIi8+CjxyZWN0IHg9IjUwIiB5PSI1MCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNGMEYwRjAiLz4KPHBhdGggZD0iTTEwMCAxMDBMMjAwIDEwMEwyMDAgMjAwTDEwMCAyMDBMMTAwIDEwMFoiIGZpbGw9IiNDQ0NDQ0MiLz4KPHBhdGggZD0iTTEyNSAxMjVMMTc1IDE3NSIgc3Ryb2tlPSIjOTY5Njk2IiBzdHJva2Utd2lkdGg9IjIiLz4KPHBhdGggZD0iTTE3NSAxMjVMMTI1IDE3NSIgc3Ryb2tlPSIjOTY5Njk2IiBzdHJva2Utd2lkdGg9IjIiLz4KPC9zdmc+';
    }
    
    if (categoryId) {
        const existingCategory = categoriesWithImages.find(cat => cat.name === categoryId);
        if (existingCategory) {
            existingCategory.name = name;
            existingCategory.imageURL = imageURL;
            products.forEach(p => {
                if (p.category === categoryId) {
                    p.category = name;
                }
            });
            await saveProductsToFirestore();
        }
    } else {
        if (categoriesWithImages.some(cat => cat.name === name)) {
            alert('هذه الفئة موجودة بالفعل.');
            return;
        }
        categoriesWithImages.unshift({ name, imageURL, visible: true });
    }
    
    await saveCategoriesToFirestore();
    loadCategories();
    loadProducts();
    addCategory();
    
    alert('تم حفظ الفئة بنجاح!');
}

// ============ وظائف إدارة الكوبونات ============
function loadCoupons() {
    const couponsList = document.getElementById('couponsList');
    if (!couponsList) return;
    
    couponsList.innerHTML = '';
    
    if (coupons.length === 0) {
        couponsList.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد كوبونات حالياً.</p>';
    } else {
        coupons.forEach(coupon => {
            const couponCard = document.createElement('div');
            couponCard.className = 'coupon-card';
            couponCard.innerHTML = `
                <div class="coupon-header">
                    <div class="coupon-code">${coupon.code}</div>
                    <div class="coupon-value">${coupon.value} د.ل</div>
                </div>
                <div class="coupon-details">
                    تم استخدامه ${coupon.used || 0} من ${coupon.maxUsage || 0} مرات
                </div>
                <div class="category-actions">
                    ${checkPermission('coupons', 'delete') ? `<button class="action-btn delete-btn" data-code="${coupon.code}">حذف</button>` : ''}
                </div>
            `;
            couponsList.appendChild(couponCard);
        });
        document.querySelectorAll('#couponsList .delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const code = this.getAttribute('data-code');
                deleteCoupon(code);
            });
        });
    }
}

async function deleteCoupon(code) {
    if (!checkPermission('coupons', 'delete')) {
        alert('ليس لديك صلاحية لحذف الكوبونات');
        return;
    }
    
    if (confirm('هل أنت متأكد من حذف هذا الكوبون؟')) {
        coupons = coupons.filter(c => c.code !== code);
        await saveCouponsToFirestore();
        loadCoupons();
        alert('تم حذف الكوبون بنجاح!');
    }
}

async function saveCoupon() {
    if (!checkPermission('coupons', 'edit')) {
        alert('ليس لديك صلاحية لإضافة كوبونات');
        return;
    }
    
    const code = document.getElementById('couponCode')?.value.trim().toUpperCase();
    const value = parseFloat(document.getElementById('couponValue')?.value);
    const maxUsage = parseInt(document.getElementById('couponUsage')?.value);
    
    if (!code || isNaN(value) || isNaN(maxUsage) || maxUsage < 1) {
        alert('الرجاء ملء جميع الحقول بشكل صحيح.');
        return;
    }
    
    if (coupons.find(c => c.code === code)) {
        alert('الكود موجود بالفعل.');
        return;
    }
    
    coupons.push({ code, value, maxUsage, used: 0 });
    await saveCouponsToFirestore();
    loadCoupons();
    const couponForm = document.getElementById('couponForm');
    if (couponForm) couponForm.reset();
    alert('تم إضافة الكوبون بنجاح!');
}

// ============ وظائف إدارة الطلبات ============
function loadOrders(searchTerm = '', page = 1) {
    const ordersList = document.getElementById('ordersList');
    if (!ordersList) return;
    
    ordersList.innerHTML = '';
    
    currentOrdersPage = page;
    
    orders.sort((a, b) => b.id - a.id);
    
    const filteredOrders = orders.filter(order => 
        order.id.toString().includes(searchTerm) ||
        (order.customer.name && order.customer.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (order.customer.phone && order.customer.phone.includes(searchTerm))
    );
    
    if (filteredOrders.length === 0) {
        ordersList.innerHTML = `
            <p style="text-align: center; padding: 20px;">
                <i class="fas fa-box-open" style="font-size: 24px; color: #ccc;"></i><br>
                لا توجد طلبات تطابق البحث.
            </p>
        `;
        const ordersPagination = document.getElementById('ordersPagination');
        if (ordersPagination) {
            ordersPagination.style.display = 'none';
        }
        return;
    }
    
    const { startIndex, endIndex } = setupPagination(
        filteredOrders, 
        'ordersList', 
        'ordersPagination', 
        currentOrdersPage, 
        itemsPerPage,
        (newPage) => loadOrders(searchTerm, newPage)
    );
    
    const ordersToShow = filteredOrders.slice(startIndex, endIndex);
    
    ordersToShow.forEach(order => {
        const orderCard = document.createElement('div');
        orderCard.className = 'order-card';
        
        let orderDetailsBoxes = '';
        order.items.forEach(item => {
            const currentProduct = products.find(p => p.id == item.id);
            const specsToDisplay = currentProduct ? currentProduct.specs : item.specs;
            const imageToDisplay = currentProduct ? (currentProduct.images ? currentProduct.images[0] : null) : item.image;
            
            let specsHTML = '';
            if (specsToDisplay && specsToDisplay.length > 0) {
                specsHTML = specsToDisplay.map(spec => 
                    `<div><span class="detail-label">${spec.label}:</span> ${spec.value}</div>`
                ).join('');
            }
            
            orderDetailsBoxes += `
                <div class="order-details-box">
                    <div><span class="detail-label">المنتج:</span></div>
                    <div>
                        <img src="${imageToDisplay || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkZGRkZGIi8+CjxyZWN0IHg9IjE1IiB5PSIxNSIgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0zNSAzNUw2NSAzNUw2NSA2NUwzNSA2NUwzNSAzNVoiIGZpbGw9IiNDQ0NDQ0MiLz4KPHBhdGggZD0iTTQyIDQyTDU4IDU4IiBzdHJva2U9IiM5Njk2OTYiIHN0cm9rZS13aWR0aD0iMS41Ii8+CjxwYXRoIGQ9Ik01OCA0Mkw0MiA1OCIgc3Ryb2tlPSIjOTY5Njk2IiBzdHJva2Utd2lkdGg9IjEuNSIvPgo8L3N2Zz4='}" alt="صورة المنتج" style="width: 100px; height: 100px; object-fit: contain; border-radius: 8px;">
                    </div>
                    <div><span class="detail-label">اسم المنتج:</span> ${item.name}</div>
                    <div><span class="detail-label">المواصفات:</span></div>
                    ${specsHTML}
                    <div><span class="detail-label">عدد القطع:</span> ${item.quantity}</div>
                </div>
            `;
        });
        
        let couponInfo = '';
        if (order.couponUsed) {
            couponInfo = `
                <div class="order-coupon-info">
                    <strong>كوبون مستخدم:</strong> تم تطبيق خصم بقيمة ${order.couponUsed.value} د.ل
                </div>
            `;
        }
        
        orderCard.innerHTML = `
            <div class="order-header">
                <div class="order-id">طلب رقم: #${order.id}</div>
                <div class="order-date">${order.date}</div>
            </div>
            <div class="order-customer">
                <div><strong>العميل:</strong> ${order.customer.name || ''}</div>
                <div><strong>الهاتف:</strong> ${order.customer.phone || ''}</div>
                <div><strong>المدينة:</strong> ${order.customer.city || ''}</div>
                <div><strong>العنوان:</strong> ${order.customer.address || ''}</div>
                ${order.deliveryMethod ? `<div><strong>طريقة الاستلام:</strong> ${order.deliveryMethod === 'delivery' ? 'توصيل' : 'حجز'}</div>` : ''}
                ${order.notes ? `<div><strong>ملاحظات:</strong> ${order.notes}</div>` : ''}
            </div>
            ${couponInfo}
            ${orderDetailsBoxes}
            <div class="order-footer">
                <div class="order-total">المجموع: ${order.total} د.ل</div>
                <div class="order-status-select-container">
                    <select class="order-status-select ${order.status}" data-id="${order.id}">
                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>قيد الانتظار</option>
                        <option value="approved" ${order.status === 'approved' ? 'selected' : ''}>تمت الموافقة</option>
                        <option value="rejected" ${order.status === 'rejected' ? 'selected' : ''}>تم الرفض</option>
                    </select>
                    ${checkPermission('orders', 'edit') ? `<button class="update-status-btn" data-id="${order.id}">تحديث الحالة</button>` : ''}
                    ${checkPermission('orders', 'delete') ? `<button class="delete-order-btn" data-id="${order.id}">حذف الطلب</button>` : ''}
                </div>
            </div>
        `;
        ordersList.appendChild(orderCard);
    });
    
    document.querySelectorAll('.order-status-select').forEach(select => {
        select.addEventListener('change', function() {
            this.className = `order-status-select ${this.value}`;
        });
    });
    
    document.querySelectorAll('.update-status-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = parseInt(this.getAttribute('data-id'));
            const select = document.querySelector(`.order-status-select[data-id="${orderId}"]`);
            const newStatus = select.value;
            withLoading(this, () => updateOrderStatus(orderId, newStatus));
        });
    });
    
    document.querySelectorAll('.delete-order-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.getAttribute('data-id');
            deleteOrder(orderId);
        });
    });
    
    updateOrdersBadge();
}

async function updateOrderStatus(orderId, status) {
    if (!checkPermission('orders', 'edit')) {
        alert('ليس لديك صلاحية لتحديث حالة الطلبات');
        return;
    }
    
    const order = orders.find(o => o.id == orderId);
    if (order) {
        if (status === 'approved') {
            order.items.forEach(item => {
                const productIndex = products.findIndex(p => p.id == item.id);
                if (productIndex !== -1) {
                    if (products[productIndex].quantity !== undefined) {
                        products[productIndex].quantity -= item.quantity;
                        if (products[productIndex].quantity < 0) {
                            products[productIndex].quantity = 0;
                        }
                    }
                }
            });
            await saveProductsToFirestore();
        }
        
        order.status = status;
        order.seenByCustomer = false;
        await saveOrdersToFirestore();
        
        loadOrders();
        alert(`تم تغيير حالة الطلب إلى "${getStatusText(status)}"`);
    }
}

function getStatusText(status) {
    switch(status) {
        case 'pending': return 'قيد الانتظار';
        case 'approved': return 'تمت الموافقة';
        case 'rejected': return 'تم الرفض';
        default: return status;
    }
}

async function deleteOrder(orderId) {
    if (!checkPermission('orders', 'delete')) {
        alert('ليس لديك صلاحية لحذف الطلبات');
        return;
    }
    
    if (confirm('هل أنت متأكد من حذف هذا الطلب؟')) {
        orders = orders.filter(o => o.id != orderId);
        await saveOrdersToFirestore();
        loadOrders();
        alert('تم حذف الطلب بنجاح!');
    }
}

// ============ وظائف إدارة السلايدر ============
async function loadSliderImages() {
    const sliderImagesList = document.getElementById('sliderImagesList');
    if (!sliderImagesList) return;
    
    sliderImagesList.innerHTML = '';
    
    if (sliderImages.length === 0) {
        sliderImagesList.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد صور للسلايدر حالياً.</p>';
        return;
    }

    sliderImages.forEach((url, index) => {
        const imageItem = document.createElement('div');
        imageItem.className = 'slider-image-item';
        
        imageItem.innerHTML = `
            <div class="slider-image-preview" style="background-image: url('${url}')"></div>
            <div class="slider-image-url">صورة السلايدر ${index + 1}</div>
            <div class="slider-image-actions">
                ${checkPermission('slider', 'delete') ? `<button class="action-btn delete-btn" data-index="${index}">حذف</button>` : ''}
            </div>
        `;
        sliderImagesList.appendChild(imageItem);
    });

    document.querySelectorAll('#sliderImagesList .delete-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const index = parseInt(this.getAttribute('data-index'));
            await deleteSliderImage(index);
        });
    });
}

async function addSliderImage() {
    if (!checkPermission('slider', 'edit')) {
        alert('ليس لديك صلاحية لإضافة صور للسلايدر');
        return;
    }
    
    const imageFile = document.getElementById('slideImageFile')?.files[0];
    
    if (!imageFile) {
        alert('الرجاء اختيار صورة.');
        return;
    }
    
    try {
        const base64Image = await fileToBase64(imageFile);
        const compressedImage = await compressImage(base64Image);
        
        if (!sliderImages.includes(compressedImage)) {
            sliderImages.unshift(compressedImage);
            await saveSliderToFirestore();
            loadSliderImages();
            const sliderForm = document.getElementById('sliderForm');
            if (sliderForm) sliderForm.reset();
            const slideImagePreview = document.getElementById('slideImagePreview');
            if (slideImagePreview) slideImagePreview.innerHTML = '';
            alert('تم إضافة الصورة بنجاح');
        } else {
            alert('هذه الصورة موجودة بالفعل.');
        }
    } catch (error) {
        alert('حدث خطأ في تحميل الصورة');
    }
}

async function deleteSliderImage(index) {
    if (!checkPermission('slider', 'delete')) {
        alert('ليس لديك صلاحية لحذف صور السلايدر');
        return;
    }
    
    if (confirm('هل أنت متأكد من حذف هذه الصورة من السلايدر؟')) {
        sliderImages.splice(index, 1);
        await saveSliderToFirestore();
        loadSliderImages();
        alert('تم حذف الصورة بنجاح!');
    }
}

// ============ وظائف مساعدة عامة ============
function updateOrdersBadge() {
    const pendingOrders = orders.filter(order => order.status === 'pending');
    const badge = document.getElementById('orders-badge');
    if (badge) {
        if (pendingOrders.length > 0) {
            badge.style.display = 'block';
            badge.textContent = pendingOrders.length;
        } else {
            badge.style.display = 'none';
        }
    }
}

function setupPagination(items, containerId, paginationId, currentPage, itemsPerPage, renderFunction) {
    const totalItems = items.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const paginationContainer = document.getElementById(paginationId);
    
    if (!paginationContainer || totalPages <= 1) {
        if (paginationContainer) {
            paginationContainer.style.display = 'none';
        }
        return { startIndex: 0, endIndex: items.length };
    }
    
    paginationContainer.style.display = 'flex';
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
    
    const prevButton = paginationContainer.querySelector('button:first-child');
    const nextButton = paginationContainer.querySelector('button:last-child');
    
    if (prevButton) prevButton.disabled = currentPage === 1;
    if (nextButton) nextButton.disabled = currentPage === totalPages;
    
    const numbersContainer = paginationContainer.querySelector('.pagination-numbers');
    if (numbersContainer) {
        numbersContainer.innerHTML = '';
        
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        if (startPage > 1) {
            const firstPage = document.createElement('div');
            firstPage.className = 'pagination-number';
            firstPage.textContent = '1';
            firstPage.addEventListener('click', () => {
                renderFunction(1);
            });
            numbersContainer.appendChild(firstPage);
            
            if (startPage > 2) {
                const ellipsis = document.createElement('div');
                ellipsis.className = 'pagination-number';
                ellipsis.textContent = '...';
                ellipsis.style.cursor = 'default';
                numbersContainer.appendChild(ellipsis);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageNumber = document.createElement('div');
            pageNumber.className = `pagination-number ${i === currentPage ? 'active' : ''}`;
            pageNumber.textContent = i;
            pageNumber.addEventListener('click', () => {
                renderFunction(i);
            });
            numbersContainer.appendChild(pageNumber);
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('div');
                ellipsis.className = 'pagination-number';
                ellipsis.textContent = '...';
                ellipsis.style.cursor = 'default';
                numbersContainer.appendChild(ellipsis);
            }
            
            const lastPage = document.createElement('div');
            lastPage.className = 'pagination-number';
            lastPage.textContent = totalPages;
            lastPage.addEventListener('click', () => {
                renderFunction(totalPages);
            });
            numbersContainer.appendChild(lastPage);
        }
        
        if (prevButton) {
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    renderFunction(currentPage - 1);
                }
            };
        }
        
        if (nextButton) {
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    renderFunction(currentPage + 1);
                }
            };
        }
    }
    
    return { startIndex, endIndex };
}

function setupNavigation() {
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => {
        item.addEventListener('click', function() {
            const targetPage = this.getAttribute('data-page');
            
            if (!targetPage) return;
            
            menuItems.forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            const targetElement = document.getElementById(targetPage);
            if (targetElement) {
                targetElement.classList.add('active');
            }
            
            if (targetPage === 'ordersPage') {
                loadOrders();
            } else if (targetPage === 'sliderPage') {
                loadSliderImages();
            } else if (targetPage === 'accountsPage') {
                loadAccounts();
            } else if (targetPage === 'systemAccountsPage') {
                loadSystemAccounts();
            }
        });
    });
}

function updateCustomerProducts() {
    const visibleProducts = products.filter(p => {
        const category = categoriesWithImages.find(c => c.name === p.category);
        return category ? category.visible : false;
    });
    
    const customerProducts = visibleProducts.map(p => ({
        id: p.id,
        name: p.name,
        price: p.sellPrice,
        image: p.images && p.images[0] ? p.images[0] : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRkZGRkZGIi8+CjxyZWN0IHg9IjUwIiB5PSI1MCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNGMEYwRjAiLz4KPHBhdGggZD0iTTEwMCAxMDBMMjAwIDEwMEwyMDAgMjAwTDEwMCAyMDBMMTAwIDEwMFoiIGZpbGw9IiNDQ0NDQ0MiLz4KPHBhdGggZD0iTTEyNSAxMjVMMTc1IDE3NSIgc3Ryb2tlPSIjOTY5Njk2IiBzdHJva2Utd2lkdGg9IjIiLz4KPHBhdGggZD0iTTE3NSAxMjVMMTI1IDE3NSIgc3Ryb2tlPSIjOTY5Njk2IiBzdHJva2Utd2lkdGg9IjIiLz4KPC9zdmc+',
        category: p.category,
        generalDescription: p.generalDescription,
        specs: p.specs,
        timer: p.timer,
        discount: p.discount,
        quantity: p.quantity !== undefined ? p.quantity : 10,
        createdAt: p.createdAt || new Date().getTime()
    }));
    localStorage.setItem('products', JSON.stringify(customerProducts));
}

function updateCustomerCategories() {
    const visibleCategories = categoriesWithImages.filter(c => c.visible);
    const customerCategories = visibleCategories.map(c => c.name);
    localStorage.setItem('categories', JSON.stringify(["الكل", ...customerCategories]));
    localStorage.setItem('categoriesWithImages', JSON.stringify(categoriesWithImages));
}

function updateCustomerSlider() {
    localStorage.setItem('customerSliderImages', JSON.stringify(sliderImages));
}

// ============ وظائف معالجة الصور ============
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

function compressImage(base64Image, maxWidth = 800, quality = 0.7) {
    return new Promise((resolve) => {
        const img = new Image();
        img.src = base64Image;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.onerror = () => resolve(base64Image);
    });
}

function previewImages(input, previewContainerId) {
    const previewContainer = document.getElementById(previewContainerId);
    previewContainer.innerHTML = '';
    
    if (input.files) {
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'image-preview';
                previewContainer.appendChild(img);
            }
            reader.readAsDataURL(file);
        });
    }
}

function displayImagesGrid() {
    const imagesGrid = document.getElementById('productImagesGrid');
    const imagesCounter = document.getElementById('imagesCounter');
    
    if (!imagesGrid || !imagesCounter) return;
    
    imagesGrid.innerHTML = '';
    
    if (tempProductImages.length === 0) {
        imagesGrid.innerHTML = '<div class="no-images-message"><i class="fas fa-images"></i><br>لا توجد صور مضافة بعد</div>';
        imagesCounter.textContent = '0 صور مرفوعة';
        return;
    }
    
    imagesCounter.textContent = `${tempProductImages.length} صور مرفوعة`;
    
    tempProductImages.forEach((image, index) => {
        const imageItem = document.createElement('div');
        imageItem.className = 'image-item';
        
        const img = document.createElement('img');
        img.src = image.url;
        img.alt = `صورة المنتج ${index + 1}`;
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'image-item-remove';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.title = 'حذف الصورة';
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            removeImage(index);
        });
        
        imageItem.appendChild(img);
        imageItem.appendChild(removeBtn);
        imagesGrid.appendChild(imageItem);
    });
}

function addProductImages(files) {
    if (!files || files.length === 0) return;
    
    Array.from(files).forEach(file => {
        if (file.size > 5 * 1024 * 1024) {
            alert(`الصورة ${file.name} حجمها أكبر من 5MB. الرجاء اختيار صورة أصغر.`);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            tempProductImages.push({
                file: file,
                url: e.target.result,
                isNew: true
            });
            displayImagesGrid();
        };
        reader.readAsDataURL(file);
    });
    
    const fileInput = document.getElementById('productImagesInputModal');
    if (fileInput) {
        fileInput.value = '';
    }
}

function removeImage(index) {
    if (confirm('هل تريد حذف هذه الصورة؟')) {
        tempProductImages.splice(index, 1);
        displayImagesGrid();
    }
}

function setupDragAndDrop() {
    const uploadArea = document.getElementById('productImagesUploadArea');
    const fileInput = document.getElementById('productImagesInputModal');
    
    if (!uploadArea || !fileInput) return;
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        uploadArea.classList.add('highlight');
    }
    
    function unhighlight() {
        uploadArea.classList.remove('highlight');
    }
    
    uploadArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        addProductImages(files);
    }
}

// ============ وظائف المواصفات ============
function addSpecificationModal() {
    const label = document.getElementById('specLabelModal')?.value.trim();
    const value = document.getElementById('specValueModal')?.value.trim();
    
    if (label && value) {
        tempSpecsModal.push({ label, value });
        renderSpecsListModal();
        const specLabelModal = document.getElementById('specLabelModal');
        const specValueModal = document.getElementById('specValueModal');
        if (specLabelModal) specLabelModal.value = '';
        if (specValueModal) specValueModal.value = '';
    }
}

function renderSpecsListModal() {
    const specsList = document.getElementById('specsListModal');
    if (!specsList) return;
    
    specsList.innerHTML = '';
    
    if (tempSpecsModal.length === 0) {
        specsList.innerHTML = '<p style="text-align: center; color: #999;">لا توجد مواصفات مضافة</p>';
        return;
    }
    
    tempSpecsModal.forEach((spec, index) => {
        const specItem = document.createElement('div');
        specItem.className = 'spec-item';
        specItem.innerHTML = `
            <span>${spec.label}: ${spec.value}</span>
            <button type="button" class="remove-spec" data-index="${index}">
                <i class="fas fa-trash"></i>
            </button>
        `;
        specsList.appendChild(specItem);
    });
    
    document.querySelectorAll('#specsListModal .remove-spec').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            tempSpecsModal.splice(index, 1);
            renderSpecsListModal();
        });
    });
}

// ============ إعداد مستمعي الأحداث ============
function setupEventListeners() {
    const addProductBtn = document.getElementById('addProductBtn');
    const categoryForm = document.getElementById('categoryForm');
    const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');
    const couponForm = document.getElementById('couponForm');
    const sliderForm = document.getElementById('sliderForm');
    const productSearch = document.getElementById('productSearch');
    const orderSearch = document.getElementById('orderSearch');
    const accountSearch = document.getElementById('accountSearch');
    const backToCategoriesBtn = document.getElementById('backToCategoriesBtn');
    const categoryProductSearch = document.getElementById('categoryProductSearch');
    const backToAccountsBtn = document.getElementById('backToAccountsBtn');
    const productImagesInputModal = document.getElementById('productImagesInputModal');
    const categoryImageFile = document.getElementById('categoryImageFile');
    const slideImageFile = document.getElementById('slideImageFile');
    const addMoreImagesBtn = document.getElementById('addMoreImagesBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const addSystemAccountBtn = document.getElementById('addSystemAccountBtn');
    const systemAccountSearch = document.getElementById('systemAccountSearch');
    const saveCategoriesOrderBtn = document.getElementById('saveCategoriesOrderBtn');
    
    if (addProductBtn) {
        addProductBtn.addEventListener('click', addProduct);
    }
    
    if (categoryForm) {
        categoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            withLoading(document.getElementById('saveCategoryBtn'), saveCategory);
        });
    }
    
    if (cancelCategoryBtn) {
        cancelCategoryBtn.addEventListener('click', addCategory);
    }

    if (couponForm) {
        couponForm.addEventListener('submit', function(e) {
            e.preventDefault();
            withLoading(document.getElementById('saveCouponBtn'), saveCoupon);
        });
    }

    if (sliderForm) {
        sliderForm.addEventListener('submit', function(e) {
            e.preventDefault();
            withLoading(document.getElementById('addSliderImageBtn'), addSliderImage);
        });
    }
    
    if (productSearch) {
        productSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value;
            loadProducts(searchTerm);
        });
    }
    
    if (orderSearch) {
        orderSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value;
            loadOrders(searchTerm);
        });
    }
    
    if (accountSearch) {
        accountSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value;
            loadAccounts(searchTerm);
        });
    }
    
    if (backToCategoriesBtn) {
        backToCategoriesBtn.addEventListener('click', function() {
            const categoryProductsPage = document.getElementById('categoryProductsPage');
            const categoriesPage = document.getElementById('categoriesPage');
            
            if (categoryProductsPage) categoryProductsPage.classList.remove('active');
            if (categoriesPage) categoriesPage.classList.add('active');
            
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            const categoriesMenu = document.querySelector('.menu-item[data-page="categoriesPage"]');
            if (categoriesMenu) categoriesMenu.classList.add('active');
            
            currentCategoryView = '';
        });
    }
    
    if (categoryProductSearch) {
        categoryProductSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value;
            loadCategoryProducts(searchTerm);
        });
    }
    
    if (backToAccountsBtn) {
        backToAccountsBtn.addEventListener('click', function() {
            const userOrdersPage = document.getElementById('userOrdersPage');
            const accountsPage = document.getElementById('accountsPage');
            
            if (userOrdersPage) userOrdersPage.classList.remove('active');
            if (accountsPage) accountsPage.classList.add('active');
            
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            const accountsMenu = document.querySelector('.menu-item[data-page="accountsPage"]');
            if (accountsMenu) accountsMenu.classList.add('active');
            
            currentUserView = null;
        });
    }
    
    if (productImagesInputModal) {
        productImagesInputModal.addEventListener('change', function() {
            addProductImages(this.files);
        });
    }
    
    if (categoryImageFile) {
        categoryImageFile.addEventListener('change', function() {
            previewImages(this, 'categoryImagePreview');
        });
    }
    
    if (slideImageFile) {
        slideImageFile.addEventListener('change', function() {
            previewImages(this, 'slideImagePreview');
        });
    }
    
    if (addMoreImagesBtn) {
        addMoreImagesBtn.addEventListener('click', function() {
            if (productImagesInputModal) {
                productImagesInputModal.click();
            }
        });
    }
    
    if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
    }
    
    if (addSystemAccountBtn) {
        addSystemAccountBtn.addEventListener('click', openAddSystemAccountModal);
    }
    
    if (systemAccountSearch) {
        systemAccountSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value;
            loadSystemAccounts(searchTerm);
        });
    }
    
    if (saveCategoriesOrderBtn) {
        saveCategoriesOrderBtn.addEventListener('click', function() {
            withLoading(saveCategoriesOrderBtn, saveCategoriesOrder);
        });
    }
    
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-system-account-btn')) {
            const email = e.target.closest('.edit-system-account-btn').getAttribute('data-email');
            openEditSystemAccountModal(email);
        }
        
        if (e.target.closest('.delete-system-account-btn')) {
            const email = e.target.closest('.delete-system-account-btn').getAttribute('data-email');
            if (confirm(`هل أنت متأكد من حذف حساب ${email}؟`)) {
                deleteSystemAccountByEmail(email);
            }
        }
        
        if (e.target.closest('#accountsPage .edit-btn')) {
            const phone = e.target.closest('#accountsPage .edit-btn').getAttribute('data-phone');
            openEditAccountModal(phone);
        }
        
        if (e.target.closest('#accountsPage .delete-btn')) {
            const phone = e.target.closest('#accountsPage .delete-btn').getAttribute('data-phone');
            if (checkPermission('accounts', 'delete')) {
                if (confirm('هل أنت متأكد من حذف هذا الحساب؟')) {
                    deleteAccountByPhone(phone);
                }
            } else {
                alert('ليس لديك صلاحية لحذف حسابات العملاء');
            }
        }
        
        if (e.target.closest('#accountsPage .user-orders-btn')) {
            const phone = e.target.closest('#accountsPage .user-orders-btn').getAttribute('data-phone');
            viewUserOrders(phone);
        }
    });
}

async function deleteSystemAccountByEmail(email) {
    if (!checkPermission('systemAccounts', 'delete')) {
        alert('ليس لديك صلاحية لحذف حسابات المنظومة');
        return;
    }
    
    if (loggedInAccount && loggedInAccount.email === email) {
        alert('لا يمكنك حذف الحساب المسجل دخول به حالياً');
        return;
    }
    
    if (confirm(`هل أنت متأكد من حذف حساب ${email}؟`)) {
        systemAccounts = systemAccounts.filter(acc => acc.email !== email);
        await saveSystemAccountsToFirestore();
        loadSystemAccounts();
        alert('تم حذف الحساب بنجاح');
    }
}

function setupModalListeners() {
    const closeProductModalBtn = document.getElementById('closeProductModal');
    const cancelProductModalBtn = document.getElementById('cancelProductModal');
    const saveProductModalBtn = document.getElementById('saveProductModal');
    const addSpecBtnModal = document.getElementById('addSpecBtnModal');
    const enableTimerModal = document.getElementById('enableTimerModal');
    const enableDiscountModal = document.getElementById('enableDiscountModal');
    const productQuantityModal = document.getElementById('productQuantityModal');
    const productModalOverlay = document.getElementById('productModalOverlay');
    
    if (closeProductModalBtn) {
        closeProductModalBtn.addEventListener('click', closeProductModal);
    }
    
    if (cancelProductModalBtn) {
        cancelProductModalBtn.addEventListener('click', closeProductModal);
    }
    
    if (saveProductModalBtn) {
        saveProductModalBtn.addEventListener('click', function() {
            withLoading(saveProductModalBtn, saveProduct);
        });
    }
    
    if (addSpecBtnModal) {
        addSpecBtnModal.addEventListener('click', addSpecificationModal);
    }
    
    if (enableTimerModal) {
        enableTimerModal.addEventListener('change', function() {
            const timerInputsModal = document.getElementById('timerInputsModal');
            if (timerInputsModal) {
                timerInputsModal.style.display = this.checked ? 'flex' : 'none';
            }
        });
    }
    
    if (enableDiscountModal) {
        enableDiscountModal.addEventListener('change', function() {
            const discountInputModal = document.getElementById('discountInputModal');
            if (discountInputModal) {
                discountInputModal.style.display = this.checked ? 'block' : 'none';
            }
        });
    }
    
    if (productQuantityModal) {
        productQuantityModal.addEventListener('input', function() {
            const quantity = parseInt(this.value) || 0;
            const quantityWarning = document.getElementById('quantityWarning');
            
            if (quantityWarning) {
                if (quantity <= 0) {
                    quantityWarning.style.display = 'flex';
                } else {
                    quantityWarning.style.display = 'none';
                }
            }
        });
    }
    
    if (productModalOverlay) {
        productModalOverlay.addEventListener('click', function(e) {
            if (e.target === this) {
                closeProductModal();
            }
        });
    }
    
    document.addEventListener('keydown', function(e) {
        const productModalOverlay = document.getElementById('productModalOverlay');
        if (e.key === 'Escape' && productModalOverlay && productModalOverlay.classList.contains('active')) {
            closeProductModal();
        }
    });
    
    const closeEditAccountModalBtn = document.getElementById('closeEditAccountModal');
    const cancelEditAccountModalBtn = document.getElementById('cancelEditAccountModal');
    const saveAccountModalBtn = document.getElementById('saveAccountModal');
    const deleteAccountModalBtn = document.getElementById('deleteAccountModal');
    const addAddressInEditModalBtn = document.getElementById('addAddressInEditModal');
    const closeAddAddressModalBtn = document.getElementById('closeAddAddressModal');
    const cancelAddAddressModalBtn = document.getElementById('cancelAddAddressModal');
    const saveAddressModalBtn = document.getElementById('saveAddressModal');
    const editAccountModalOverlay = document.getElementById('editAccountModalOverlay');
    const addAddressModalOverlay = document.getElementById('addAddressModalOverlay');
    
    if (closeEditAccountModalBtn) {
        closeEditAccountModalBtn.addEventListener('click', closeEditAccountModal);
    }
    
    if (cancelEditAccountModalBtn) {
        cancelEditAccountModalBtn.addEventListener('click', closeEditAccountModal);
    }
    
    if (saveAccountModalBtn) {
        saveAccountModalBtn.addEventListener('click', function() {
            withLoading(saveAccountModalBtn, saveAccountChanges);
        });
    }
    
    if (deleteAccountModalBtn) {
        deleteAccountModalBtn.addEventListener('click', deleteAccount);
    }
    
    if (addAddressInEditModalBtn) {
        addAddressInEditModalBtn.addEventListener('click', openAddAddressModal);
    }
    
    if (closeAddAddressModalBtn) {
        closeAddAddressModalBtn.addEventListener('click', closeAddAddressModal);
    }
    
    if (cancelAddAddressModalBtn) {
        cancelAddAddressModalBtn.addEventListener('click', closeAddAddressModal);
    }
    
    if (saveAddressModalBtn) {
        saveAddressModalBtn.addEventListener('click', function() {
            withLoading(saveAddressModalBtn, saveAddress);
        });
    }
    
    if (editAccountModalOverlay) {
        editAccountModalOverlay.addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditAccountModal();
            }
        });
    }
    
    if (addAddressModalOverlay) {
        addAddressModalOverlay.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddAddressModal();
            }
        });
    }
    
    document.addEventListener('keydown', function(e) {
        const editAccountModalOverlay = document.getElementById('editAccountModalOverlay');
        const addAddressModalOverlay = document.getElementById('addAddressModalOverlay');
        
        if (e.key === 'Escape') {
            if (editAccountModalOverlay && editAccountModalOverlay.classList.contains('active')) {
                closeEditAccountModal();
            } else if (addAddressModalOverlay && addAddressModalOverlay.classList.contains('active')) {
                closeAddAddressModal();
            }
        }
    });
    
    const closeSystemAccountModalBtn = document.getElementById('closeSystemAccountModal');
    const cancelSystemAccountModalBtn = document.getElementById('cancelSystemAccountModal');
    const saveSystemAccountModalBtn = document.getElementById('saveSystemAccountModal');
    const deleteSystemAccountModalBtn = document.getElementById('deleteSystemAccountModal');
    const systemAccountModalOverlay = document.getElementById('systemAccountModalOverlay');
    
    if (closeSystemAccountModalBtn) {
        closeSystemAccountModalBtn.addEventListener('click', closeSystemAccountModal);
    }
    
    if (cancelSystemAccountModalBtn) {
        cancelSystemAccountModalBtn.addEventListener('click', closeSystemAccountModal);
    }
    
    if (saveSystemAccountModalBtn) {
        saveSystemAccountModalBtn.addEventListener('click', function() {
            withLoading(saveSystemAccountModalBtn, saveSystemAccount);
        });
    }
    
    if (deleteSystemAccountModalBtn) {
        deleteSystemAccountModalBtn.addEventListener('click', deleteSystemAccount);
    }
    
    if (systemAccountModalOverlay) {
        systemAccountModalOverlay.addEventListener('click', function(e) {
            if (e.target === this) {
                closeSystemAccountModal();
            }
        });
    }
    
    setupDragAndDrop();
}
    
</script>

</body>
</html>
